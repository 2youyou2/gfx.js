var gfx=function(){"use strict";const e=9728;const t=9729;const i=9984;const r=9985;const n=9986;const _=9987;const s=5121;const l=5123;const a=5125;const f=5126;const T=33635;const o=32819;const h=32820;const u=36193;const E=6402;const d=6406;const c=6407;const m=6408;const p=6409;const R=6410;const A=33776;const F=33777;const b=33778;const U=33779;const x=35840;const S=35841;const B=35842;const L=35843;const P=36196;const N=[[e,i,n],[t,r,_]];const M=[{format:c,internalFormat:A,pixelType:null},{format:m,internalFormat:F,pixelType:null},{format:m,internalFormat:b,pixelType:null},{format:m,internalFormat:U,pixelType:null},{format:c,internalFormat:P,pixelType:null},{format:c,internalFormat:S,pixelType:null},{format:m,internalFormat:L,pixelType:null},{format:c,internalFormat:x,pixelType:null},{format:m,internalFormat:B,pixelType:null},{format:d,internalFormat:d,pixelType:s},{format:p,internalFormat:p,pixelType:s},{format:R,internalFormat:R,pixelType:s},{format:c,internalFormat:c,pixelType:T},{format:m,internalFormat:m,pixelType:h},{format:m,internalFormat:m,pixelType:o},{format:c,internalFormat:c,pixelType:s},{format:m,internalFormat:m,pixelType:s},{format:c,internalFormat:c,pixelType:u},{format:m,internalFormat:m,pixelType:u},{format:c,internalFormat:c,pixelType:f},{format:m,internalFormat:m,pixelType:f},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:E,internalFormat:E,pixelType:l},{format:E,internalFormat:E,pixelType:a},{format:null,internalFormat:null,pixelType:null}];let g={USAGE_STATIC:35044,USAGE_DYNAMIC:35048,USAGE_STREAM:35040,INDEX_FMT_UINT8:5121,INDEX_FMT_UINT16:5123,INDEX_FMT_UINT32:5125,ATTR_POSITION:"a_position",ATTR_NORMAL:"a_normal",ATTR_TANGENT:"a_tangent",ATTR_BITANGENT:"a_bitangent",ATTR_WEIGHT:"a_weight",ATTR_INDICES:"a_indices",ATTR_COLOR:"a_color",ATTR_COLOR0:"a_color0",ATTR_COLOR1:"a_color1",ATTR_UV:"a_uv",ATTR_UV0:"a_uv0",ATTR_UV1:"a_uv1",ATTR_UV2:"a_uv2",ATTR_UV3:"a_uv3",ATTR_UV4:"a_uv4",ATTR_UV5:"a_uv5",ATTR_UV6:"a_uv6",ATTR_UV7:"a_uv7",ATTR_TYPE_INT8:5120,ATTR_TYPE_UINT8:5121,ATTR_TYPE_INT16:5122,ATTR_TYPE_UINT16:5123,ATTR_TYPE_INT32:5124,ATTR_TYPE_UINT32:5125,ATTR_TYPE_FLOAT32:5126,FILTER_NEAREST:0,FILTER_LINEAR:1,WRAP_REPEAT:10497,WRAP_CLAMP:33071,WRAP_MIRROR:33648,TEXTURE_FMT_RGB_DXT1:0,TEXTURE_FMT_RGBA_DXT1:1,TEXTURE_FMT_RGBA_DXT3:2,TEXTURE_FMT_RGBA_DXT5:3,TEXTURE_FMT_RGB_ETC1:4,TEXTURE_FMT_RGB_PVRTC_2BPPV1:5,TEXTURE_FMT_RGBA_PVRTC_2BPPV1:6,TEXTURE_FMT_RGB_PVRTC_4BPPV1:7,TEXTURE_FMT_RGBA_PVRTC_4BPPV1:8,TEXTURE_FMT_A8:9,TEXTURE_FMT_L8:10,TEXTURE_FMT_L8_A8:11,TEXTURE_FMT_R5_G6_B5:12,TEXTURE_FMT_R5_G5_B5_A1:13,TEXTURE_FMT_R4_G4_B4_A4:14,TEXTURE_FMT_RGB8:15,TEXTURE_FMT_RGBA8:16,TEXTURE_FMT_RGB16F:17,TEXTURE_FMT_RGBA16F:18,TEXTURE_FMT_RGB32F:19,TEXTURE_FMT_RGBA32F:20,TEXTURE_FMT_R32F:21,TEXTURE_FMT_111110F:22,TEXTURE_FMT_SRGB:23,TEXTURE_FMT_SRGBA:24,TEXTURE_FMT_D16:25,TEXTURE_FMT_D32:26,TEXTURE_FMT_D24S8:27,RB_FMT_RGBA4:32854,RB_FMT_RGB5_A1:32855,RB_FMT_RGB565:36194,RB_FMT_D16:33189,RB_FMT_S8:36168,RB_FMT_D24S8:34041,DEPTH_FUNC_NEVER:512,DEPTH_FUNC_LESS:513,DEPTH_FUNC_EQUAL:514,DEPTH_FUNC_LEQUAL:515,DEPTH_FUNC_GREATER:516,DEPTH_FUNC_NOTEQUAL:517,DEPTH_FUNC_GEQUAL:518,DEPTH_FUNC_ALWAYS:519,BLEND_FUNC_ADD:32774,BLEND_FUNC_SUBTRACT:32778,BLEND_FUNC_REVERSE_SUBTRACT:32779,BLEND_ZERO:0,BLEND_ONE:1,BLEND_SRC_COLOR:768,BLEND_ONE_MINUS_SRC_COLOR:769,BLEND_DST_COLOR:774,BLEND_ONE_MINUS_DST_COLOR:775,BLEND_SRC_ALPHA:770,BLEND_ONE_MINUS_SRC_ALPHA:771,BLEND_DST_ALPHA:772,BLEND_ONE_MINUS_DST_ALPHA:773,BLEND_CONSTANT_COLOR:32769,BLEND_ONE_MINUS_CONSTANT_COLOR:32770,BLEND_CONSTANT_ALPHA:32771,BLEND_ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_SRC_ALPHA_SATURATE:776,CULL_NONE:0,CULL_FRONT:1028,CULL_BACK:1029,CULL_FRONT_AND_BACK:1032,PT_POINTS:0,PT_LINES:1,PT_LINE_LOOP:2,PT_LINE_STRIP:3,PT_TRIANGLES:4,PT_TRIANGLE_STRIP:5,PT_TRIANGLE_FAN:6};function D(e){if(e===g.ATTR_TYPE_INT8){return 1}else if(e===g.ATTR_TYPE_UINT8){return 1}else if(e===g.ATTR_TYPE_INT16){return 2}else if(e===g.ATTR_TYPE_UINT16){return 2}else if(e===g.ATTR_TYPE_INT32){return 4}else if(e===g.ATTR_TYPE_UINT32){return 4}else if(e===g.ATTR_TYPE_FLOAT32){return 4}console.warn(`Unknown ATTR_TYPE: ${e}`);return 0}function C(e,t,i=-1){let r=N[t][i+1];if(r===undefined){console.warn(`Unknown FILTER: ${t}`);return i===-1?e.LINEAR:e.LINEAR_MIPMAP_LINEAR}return r}function I(e){let t=M[e];if(t===undefined){console.warn(`Unknown TEXTURE_FMT: ${e}`);return M[g.TEXTURE_FMT_RGBA8]}return t}class y{constructor(e){this._attr2el={};this._elements=[];this._bytes=0;let t=0;for(let i=0,r=e.length;i<r;++i){let r=e[i];let n={name:r.name,offset:t,stride:0,stream:-1,type:r.type,num:r.num,normalize:r.normalize===undefined?false:r.normalize,bytes:r.num*D(r.type)};this._attr2el[n.name]=n;this._elements.push(n);this._bytes+=n.bytes;t+=n.bytes}for(let e=0,t=this._elements.length;e<t;++e){let t=this._elements[e];t.stride=this._bytes}}element(e){return this._attr2el[e]}}class X{constructor(e,t,i,r,n,_){this._device=e;this._format=t;this._usage=i;this._persist=_;this._numIndices=n;let s=0;if(t===g.INDEX_FMT_UINT8){s=n}else if(t===g.INDEX_FMT_UINT16){s=2*n}else if(t===g.INDEX_FMT_UINT32){s=4*n}this._bytes=s;this._id=e._gl.createBuffer();this._data=null;this.update(0,r);e._stats.ib+=s}destroy(){if(this._id===-1){console.error("The buffer already destroyed");return}let e=this.device.gl;e.deleteBuffer(this._id);this.device._stats.ib-=this.bytes;this._id=-1}update(e,t){if(this._id===-1){console.error("The buffer is destroyed");return}if(t&&t.byteLength+e>this._bytes){console.error("Failed to update data, bytes exceed.");return}let i=this._device._gl;let r=this._usage;i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._id);if(!t){i.bufferData(i.ELEMENT_ARRAY_BUFFER,this._bytes,r)}else{if(e){i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,t,r)}else{i.bufferData(i.ELEMENT_ARRAY_BUFFER,t,r)}}i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);if(this._persist){if(this._data){this._data.set(t,e)}else{this._data=t}}}get count(){return this._numIndices}}class v{constructor(e,t,i,r,n,_){this._device=e;this._format=t;this._usage=i;this._persist=_;this._numVertices=n;this._bytes=this._format._bytes*n;this._id=e._gl.createBuffer();this._data=null;this.update(0,r);e._stats.vb+=this._bytes}destroy(){if(this._id===-1){console.error("The buffer already destroyed");return}let e=this.device.gl;e.deleteBuffer(this._id);this.device._stats.vb-=this.bytes;this._id=-1}update(e,t){if(this._id===-1){console.error("The buffer is destroyed");return}if(t&&t.byteLength+e>this._bytes){console.error("Failed to update data, bytes exceed.");return}let i=this._device._gl;let r=this._usage;i.bindBuffer(i.ARRAY_BUFFER,this._id);if(!t){i.bufferData(i.ARRAY_BUFFER,this._bytes,r)}else{if(e){i.bufferSubData(i.ARRAY_BUFFER,t,r)}else{i.bufferData(i.ARRAY_BUFFER,t,r)}}i.bindBuffer(i.ARRAY_BUFFER,null);if(this._persist){if(this._data){this._data.set(t,e)}else{this._data=t}}}get count(){return this._numVertices}}class O{constructor(e,t){this._device=e;this._attributes=[];this._uniforms=[];this._samplers=[];this._linked=false;this._vertSource=t.vert;this._fragSource=t.frag;this._program=null}link(){if(this._linked){return}let e=this._device._gl;let t=G(e,e.VERTEX_SHADER,this._vertSource);let i=G(e,e.FRAGMENT_SHADER,this._fragSource);let r=e.createProgram();e.attachShader(r,t);e.attachShader(r,i);e.linkProgram(r);let n=false;if(!e.getShaderParameter(t,e.COMPILE_STATUS)){console.error(`Failed to compile vertex shader: ${e.getShaderInfoLog(t)}`);n=true}if(!e.getShaderParameter(i,e.COMPILE_STATUS)){console.error(`Failed to compile fragment shader: ${e.getShaderInfoLog(i)}`);n=true}if(!e.getProgramParameter(r,e.LINK_STATUS)){console.error(`Failed to link shader program: ${e.getProgramInfoLog(r)}`);n=true}e.deleteShader(t);e.deleteShader(i);if(n){return}this._program=r;let _=e.getProgramParameter(r,e.ACTIVE_ATTRIBUTES);for(let t=0;t<_;++t){let i=e.getActiveAttrib(r,t);let n=e.getAttribLocation(r,i.name);this._attributes.push({name:i.name,location:n,type:i.type})}let s=e.getProgramParameter(r,e.ACTIVE_UNIFORMS);for(let t=0;t<s;++t){let i=e.getActiveUniform(r,t);let n=e.getUniformLocation(r,i.name);this._uniforms.push({name:i.name,location:n,type:i.type})}this._linked=true}destroy(){let e=this._device._gl;e.deleteProgram(this._program);this._linked=false;this._program=null;this._attributes=[];this._uniforms=[];this._samplers=[]}}function G(e,t,i){let r=e.createShader(t);e.shaderSource(r,i);e.compileShader(r);return r}class w{constructor(e){this._device=e;this._width=4;this._height=4;this._hasMipmap=false;this._compressed=false;this._anisotropy=1;this._minFilter=g.FILTER_LINEAR;this._magFilter=g.FILTER_LINEAR;this._mipFilter=g.FILTER_LINEAR;this._wrapS=g.WRAP_REPEAT;this._wrapT=g.WRAP_REPEAT;this._format=g.TEXTURE_FMT_RGBA8;this._target=-1}destroy(){if(this._id===-1){console.error("The texture already destroyed");return}let e=this.device.gl;e.deleteTexture(this._id);this.device._stats.tex-=this.bytes;this._id=-1}}function H(e){return!(e&e-1)&&!!e}class W extends w{constructor(e,t){super(e);this._target=this._device._gl.TEXTURE_2D;this.update(t)}update(e){let t=this._device._gl;let i=this._hasMipmap;if(e){if(e.width!==undefined){this._width=e.width}if(e.height!==undefined){this._height=e.height}if(e.anisotropy!==undefined){this._anisotropy=e.anisotropy}if(e.minFilter!==undefined){this._minFilter=e.minFilter}if(e.magFilter!==undefined){this._magFilter=e.magFilter}if(e.mipFilter!==undefined){this._mipFilter=e.mipFilter}if(e.wrapS!==undefined){this._wrapS=e.wrapS}if(e.wrapT!==undefined){this._wrapT=e.wrapT}if(e.format!==undefined){this._format=e.format;this._compressed=this._format>=g.TEXTURE_FMT_RGB_DXT1&&this._format<=g.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(e.mipmap!==undefined){this._hasMipmap=e.mipmap;i=e.mipmap}if(e.images!==undefined){if(e.images.length>1){i=false}}}this._id=t.createTexture();t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,this._id);let r=e.images||[null];this._setMipmap(r,e.flipY,e.premultiplyAlpha);this._setTexInfo();if(i){t.hint(t.GENERATE_MIPMAP_HINT,t.NICEST);t.generateMipmap(t.TEXTURE_2D)}this._device._restoreTexture(0)}_setMipmap(e,t,i){let r=this._device._gl;let n=I(this._format);for(let _=0;_<e.length;++_){let s=e[_];if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){if(t===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,true)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}r.texImage2D(r.TEXTURE_2D,_,n.internalFormat,n.format,n.pixelType,s)}else{if(t===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}if(this._compressed){r.compressedTexImage2D(r.TEXTURE_2D,_,n.internalFormat,this._width,this._height,0,s)}else{r.texImage2D(r.TEXTURE_2D,_,n.internalFormat,this._width,this._height,0,n.format,n.pixelType,s)}}}}_setTexInfo(){let e=this._device._gl;let t=H(this._width)&&H(this._height);if(!t&&(this._wrapS!==g.WRAP_CLAMP||this._wrapT!==g.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=g.WRAP_CLAMP;this._wrapT=g.WRAP_CLAMP}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,C(e,this._minFilter,this._hasMipmap?this._mipFilter:-1));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,C(e,this._magFilter,-1));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this._wrapS);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this._wrapT);let i=this._device.ext("EXT_texture_filter_anisotropic");if(i){e.texParameteri(e.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}}}class Y extends w{constructor(e,t){super(e);this._target=this._device._gl.TEXTURE_CUBE_MAP;this.update(t)}update(e){let t=this._device._gl;let i=this._hasMipmap;if(e){if(e.width!==undefined){this._width=e.width}if(e.height!==undefined){this._height=e.height}if(e.anisotropy!==undefined){this._anisotropy=e.anisotropy}if(e.minFilter!==undefined){this._minFilter=e.minFilter}if(e.magFilter!==undefined){this._magFilter=e.magFilter}if(e.mipFilter!==undefined){this._mipFilter=e.mipFilter}if(e.wrapS!==undefined){this._wrapS=e.wrapS}if(e.wrapT!==undefined){this._wrapT=e.wrapT}if(e.format!==undefined){this._format=e.format;this._compressed=this._format>=g.TEXTURE_FMT_RGB_DXT1&&this._format<=g.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(e.mipmap!==undefined){this._hasMipmap=e.mipmap;i=e.mipmap}if(e.images!==undefined){if(e.images.length>1){i=false}}}this._id=t.createTexture();t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_CUBE_MAP,this._id);if(e.images!==undefined){this._setMipmap(e.images,e.flipY,e.premultiplyAlpha)}this._setTexInfo();if(i){t.hint(t.GENERATE_MIPMAP_HINT,t.NICEST);t.generateMipmap(t.TEXTURE_CUBE_MAP)}this._device._restoreTexture(0)}_setMipmap(e,t,i){let r=this._device._gl;let n=I(this._format);if(t===undefined){r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,false)}else{r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}for(let t=0;t<e.length;++t){let i=e[t];for(let e=0;e<6;++e){if(i[e]instanceof HTMLCanvasElement||i[e]instanceof HTMLImageElement||i[e]instanceof HTMLVideoElement){r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,n.internalFormat,n.format,n.pixelType,i[e])}else{if(this._compressed){r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,n.internalFormat,this._width,this._height,0,i[e])}else{r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,n.internalFormat,this._width,this._height,0,n.format,n.pixelType,i[e])}}}}}_setTexInfo(){let e=this._device._gl;e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,C(e,this._minFilter,this._hasMipmap?this._mipFilter:-1));e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,C(e,this._magFilter,-1));e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,this._wrapS);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,this._wrapT);let t=this._device.ext("EXT_texture_filter_anisotropic");if(t){e.texParameteri(e.TEXTURE_CUBE_MAP,t.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}}}class V{constructor(e,t,i,r){this._device=e;this._format=t;this._width=i;this._height=r;const n=e._gl;this._rb=n.createRenderbuffer();n.bindRenderbuffer(n.RENDERBUFFER,this._rb);n.renderbufferStorage(n.RENDERBUFFER,t,i,r);n.bindRenderbuffer(n.RENDERBUFFER,null)}destroy(){if(this._rb===null){console.error("The render-buffer already destroyed");return}const e=this._device._gl;e.bindRenderbuffer(e.RENDERBUFFER,null);e.deleteRenderbuffer(this._rb);this._rb=null}}class q{constructor(e,t,i,r){this._device=e;this._width=t;this._height=i;this._colors=r.colors||[];this._depth=r.depth||null;this._stencil=r.stencil||null;this._depthStencil=r.depthStencil||null;this._fb=e._gl.createFramebuffer()}destroy(){if(this._fb===null){console.error("The frame-buffer already destroyed");return}const e=this._device._gl;e.deleteFramebuffer(this._fb);this._fb=null}}const K=-1;const k={blend:false,blendSep:K,blendColor:K,blendEq:K,blendAlphaEq:K,blendSrc:K,blendDst:K,blendSrcAlpha:K,blendDstAlpha:K,depthTest:false,depthWrite:false,depthFunc:K,cullMode:g.CULL_BACK,maxStream:-1,vertexBuffers:[],vertexBufferOffsets:[],indexBuffer:null,textureUnits:[],program:null};class z{constructor(){this.blend=false;this.blendSep=0;this.blendColor=4294967295;this.blendEq=g.BLEND_FUNC_ADD;this.blendAlphaEq=g.BLEND_FUNC_ADD;this.blendSrc=g.BLEND_ONE;this.blendDst=g.BLEND_ZERO;this.blendSrcAlpha=g.BLEND_ONE;this.blendDstAlpha=g.BLEND_ZERO;this.depthTest=false;this.depthWrite=false;this.depthFunc=g.DEPTH_FUNC_LESS;this.cullMode=g.CULL_BACK;this.maxStream=-1;this.vertexBuffers=[];this.vertexBufferOffsets=[];this.indexBuffer=null;this.textureUnits=[];this.program=null}reset(){this.set(k)}set(e){this.blend=e.blend;if(e.blendSep!==K){this.blendSep=e.blendSep}if(e.blendColor!==K){this.blendColor=e.blendColor}if(e.blendEq!==K){this.blendEq=e.blendEq}if(e.blendAlphaEq!==K){this.blendAlphaEq=e.blendAlphaEq}if(e.blendSrc!==K){this.blendSrc=e.blendSrc}if(e.blendDst!==K){this.blendDst=e.blendDst}if(e.blendSrcAlpha!==K){this.blendSrcAlpha=e.blendSrcAlpha}if(e.blendDstAlpha!==K){this.blendDstAlpha=e.blendDstAlpha}this.depthTest=e.depthTest;this.depthWrite=e.depthWrite;if(e.depthFunc!==K){this.depthFunc=e.depthFunc}this.cullMode=e.cullMode;this.maxStream=e.maxStream;for(let t=0;t<e.vertexBuffers.length;++t){this.vertexBuffers[t]=e.vertexBuffers[t]}for(let t=0;t<e.vertexBufferOffsets.length;++t){this.vertexBufferOffsets[t]=e.vertexBufferOffsets[t]}this.indexBuffer=e.indexBuffer;for(let t=0;t<e.textureUnits.length;++t){this.textureUnits[t]=e.textureUnits[t]}this.program=e.program}}const Q=5124;const Z=5126;const j=35664;const J=35665;const $=35666;const ee=35667;const te=35668;const ie=35669;const re=35670;const ne=35671;const _e=35672;const se=35673;const le=35674;const ae=35675;const fe=35676;const Te=35678;const oe=35680;let he={[Q]:function(e,t,i){e.uniform1i(t,i)},[Z]:function(e,t,i){e.uniform1f(t,i)},[j]:function(e,t,i){e.uniform2fv(t,i)},[J]:function(e,t,i){e.uniform3fv(t,i)},[$]:function(e,t,i){e.uniform4fv(t,i)},[ee]:function(e,t,i){e.uniform2iv(t,i)},[te]:function(e,t,i){e.uniform3iv(t,i)},[ie]:function(e,t,i){e.uniform4iv(t,i)},[re]:function(e,t,i){e.uniform1i(t,i)},[ne]:function(e,t,i){e.uniform2iv(t,i)},[_e]:function(e,t,i){e.uniform3iv(t,i)},[se]:function(e,t,i){e.uniform4iv(t,i)},[le]:function(e,t,i){e.uniformMatrix2fv(t,false,i)},[ae]:function(e,t,i){e.uniformMatrix3fv(t,false,i)},[fe]:function(e,t,i){e.uniformMatrix4fv(t,false,i)},[Te]:function(e,t,i){e.uniform1i(t,i)},[oe]:function(e,t,i){e.uniform1i(t,i)}};function ue(e,t,i){if(t.blend!==i.blend){if(i.blend===false){e.disable(e.BLEND);return}else{e.enable(e.BLEND)}}else{if(i.blend===false){return}}if(t.blendColor!==i.blendColor){e.blendColor((i.blendColor>>24)/255,(i.blendColor>>16&255)/255,(i.blendColor>>8&255)/255,(i.blendColor&255)/255)}if(t.blendSep!==i.blendSep){if(i.blendSep){e.blendFuncSeparate(i.blendSrc,i.blendDst,i.blendSrcAlpha,i.blendDstAlpha);e.blendEquationSeparate(i.blendEq,i.blendAlphaEq)}else{e.blendFunc(i.blendSrc,i.blendDst);e.blendEquation(i.blendEq)}return}if(i.blendSep){if(t.blendSrc!==i.blendSrc||t.blendDst!==i.blendDst||t.blendSrcAlpha!==i.blendSrcAlpha||t.blendDstAlpha!==i.blendDstAlpha){e.blendFuncSeparate(i.blendSrc,i.blendDst,i.blendSrcAlpha,i.blendDstAlpha)}if(t.blendEq!==i.blendEq||t.blendAlphaEq!==i.blendAlphaEq){e.blendEquationSeparate(i.blendEq,i.blendAlphaEq)}}else{if(t.blendSrc!==i.blendSrc||t.blendDst!==i.blendDst){e.blendFunc(i.blendSrc,i.blendDst)}if(t.blendEq!==i.blendEq){e.blendEquation(i.blendEq)}}}function Ee(e,t,i){if(t.depthWrite!==i.depthWrite){e.depthMask(i.depthWrite)}if(t.depthTest!==i.depthTest){if(i.depthTest===false){e.disable(e.DEPTH_TEST);return}else{e.enable(e.DEPTH_TEST)}}else{if(i.depthTest===false){return}}if(t.depthFunc!==i.depthFunc){e.depthFunc(i.depthFunc)}}function de(e,t,i){if(t.cullMode===i.cullMode){return}if(i.cullMode===g.CULL_NONE){e.disable(e.CULL_FACE);return}e.enable(e.CULL_FACE);e.cullFace(i.cullMode)}function ce(e,t,i){let r=false;if(t.maxStream!==i.maxStream){r=true}else if(t.program!==i.program){r=true}else{for(let e=0;e<i.maxStream+1;++e){if(t.vertexBuffers[e]!==i.vertexBuffers[e]||t.vertexBufferOffsets[e]!==i.vertexBufferOffsets[e]){r=true;break}}}if(r){for(let t=0;t<i.maxStream+1;++t){let r=i.vertexBuffers[t];let n=i.vertexBufferOffsets[t];if(!r){continue}e.bindBuffer(e.ARRAY_BUFFER,r._id);for(let t=0;t<i.program._attributes.length;++t){let _=i.program._attributes[t];let s=r._format.element(_.name);if(!s){console.warn(`Can not find vertex attribute: ${_.name}`);continue}e.enableVertexAttribArray(_.location);e.vertexAttribPointer(_.location,s.num,s.type,s.normalize,s.stride,s.offset+n*s.stride)}}}}function me(e,t,i){for(let r=0;r<i.textureUnits.length;++r){if(t.textureUnits[r]!==i.textureUnits[r]){let t=i.textureUnits[r];e.bindTexture(t._target,t._id)}}}function pe(e,t,i,r=0){if(i instanceof W){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_2D,i._id,0)}else if(i instanceof Y){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,i._id,0)}else{e.framebufferRenderbuffer(e.FRAMEBUFFER,t,e.RENDERBUFFER,i._rb)}}class Re{constructor(e,t){let i;try{i=e.getContext("webgl",t)}catch(e){console.error(e);return}this._gl=i;this._extensions={};this._caps={};this._stats={texture:0,vb:0,ib:0,drawcalls:0};this._current=new z;this._next=new z;this._uniforms={};this._primitiveType=g.PT_TRIANGLES;this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0;this._framebuffer=null;this._initExtensions(["EXT_texture_filter_anisotropic","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","WEBGL_draw_buffers"]);this._initCaps();this._initStates()}_initExtensions(e){const t=this._gl;for(let i=0;i<e.length;++i){let r=e[i];try{let e=t.getExtension(r);if(e){this._extensions[r]=e}}catch(e){console.error(e)}}}_initCaps(){const e=this._gl;const t=this.ext("WEBGL_draw_buffers");this._caps.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxFragUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxDrawBuffers=t?e.getParameter(t.MAX_DRAW_BUFFERS_WEBGL):1;this._caps.maxColorAttachments=t?e.getParameter(t.MAX_COLOR_ATTACHMENTS_WEBGL):1}_initStates(){const e=this._gl;e.disable(e.BLEND);e.blendFunc(e.ONE,e.ZERO);e.blendEquation(e.FUNC_ADD);e.colorMask(true,true,true,true);e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.disable(e.DEPTH_TEST);e.depthFunc(e.LESS);e.depthMask(false);e.clearDepth(1);e.clearColor(0,0,0,0);e.clearStencil(0);e.disable(e.SCISSOR_TEST)}_restoreTexture(e){const t=this._gl;let i=this._current.textureUnits[e];if(i){t.bindTexture(i._target,i._id)}else{t.bindTexture(t.TEXTURE_2D,null)}}ext(e){return this._extensions[e]}setFrameBuffer(e){if(this._framebuffer===e){return}this._framebuffer=e;const t=this._gl;if(e===null){t.bindFramebuffer(t.FRAMEBUFFER,null);return}t.bindFramebuffer(t.FRAMEBUFFER,e._fb);let i=this._framebuffer._colors.length;for(let e=0;e<i;++e){let i=this._framebuffer._colors[e];pe(t,t.COLOR_ATTACHMENT0+e,i)}for(let e=i;e<this._caps.maxColorAttachments;++e){t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0)}if(this._framebuffer._depth){pe(t,t.DEPTH_ATTACHMENT,this._framebuffer._depth)}else{t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,null,0)}if(this._framebuffer._stencil){pe(t,t.STENCIL_ATTACHMENT,e._stencil)}else{t.framebufferTexture2D(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.TEXTURE_2D,null,0)}if(this._framebuffer._depthStencil){pe(t,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencil)}else{t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,null,0)}}setViewport(e,t,i,r){if(this._vx!==e||this._vy!==t||this._vw!==i||this._vh!==r){this._gl.viewport(e,t,i,r);this._vx=e;this._vy=t;this._vw=i;this._vh=r}}setScissor(e,t,i,r){if(this._sx!==e||this._sy!==t||this._sw!==i||this._sh!==r){this._gl.scissor(e,t,i,r);this._sx=e;this._sy=t;this._sw=i;this._sh=r}}clear(e){const t=this._gl;let i=0;if(e.color!==undefined){i|=t.COLOR_BUFFER_BIT;t.clearColor(e.color[0],e.color[1],e.color[2],e.color[3])}if(e.depth!==undefined){i|=t.DEPTH_BUFFER_BIT;if(!this._current.depthWrite){t.depthMask(true)}t.clearDepth(e.depth)}if(e.stencil!==undefined){i|=t.STENCIL_BUFFER_BIT;t.clearStencil(e.stencil)}t.clear(i);if(e.depth!==undefined&&!this._current.depthWrite){t.depthMask(false)}}enableBlend(){this._next.blend=true}enableDepthTest(){this._next.depthTest=true}enableDepthWrite(){this._next.depthWrite=true}setBlendColor(e,t,i,r){this._next.blendColor=e*255<<24|t*255<<16|i*255<<8|r*255}setBlendFunction(e,t){this._next.blendSep=0;this._next.blendSrc=e;this._next.blendDst=t}setBlendFunctionSeparate(e,t,i,r){this._next.blendSep=1;this._next.blendSrc=e;this._next.blendDst=t;this._next.blendSrcAlpha=i;this._next.blendDstAlpha=r}setBlendEquation(e){this._next.blendSep=0;this._next.blendEq=e}setBlendEquationSeparate(e,t){this._next.blendSep=1;this._next.blendEq=e;this._next.blendAlphaEq=t}setCullMode(e){this._next.cullMode=e}setVertexBuffer(e,t,i=0){this._next.vertexBuffers[e]=t;this._next.vertexBufferOffsets[e]=i;if(this._next.maxStream<e){this._next.maxStream=e}}setIndexBuffer(e){this._next.indexBuffer=e}setProgram(e){this._next.program=e}setTexture(e,t,i){if(i>=this._caps.maxTextureUnits){console.warn(`Can not set texture ${e} at stage ${i}, max texture exceed: ${this._caps.maxTextureUnits}`);return}this._next.textureUnits[i]=t;this.setUniform(e,i)}setUniform(e,t,i=1){let r=this._uniforms[e];if(!r){r={dirty:true,value:t,num:i}}else{r.dirty=true;r.value=t;r.num=i}this._uniforms[e]=r}setPrimitiveType(e){this._primitiveType=e}draw(e,t){const i=this._gl;let r=this._current;let n=this._next;ue(i,r,n);Ee(i,r,n);de(i,r,n);ce(i,r,n);if(r.indexBuffer!==n.indexBuffer){i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n.indexBuffer?n.indexBuffer._id:null)}if(r.program!==n.program){i.useProgram(n.program._program)}me(i,r,n);for(let e=0;e<n.program._uniforms.length;++e){let t=n.program._uniforms[e];let r=this._uniforms[t.name];if(!r){continue}if(!r.dirty){continue}r.dirty=false;let _=he[t.type];if(!_){console.warn(`Can not find commit function for uniform ${t.name}`);continue}_(i,t.location,r.value)}if(n.indexBuffer){i.drawElements(this._primitiveType,t,n.indexBuffer._format,e*n.indexBuffer._bytes)}else{i.drawArrays(this._primitiveType,e,t)}this._stats.drawcalls+=1;r.set(n);n.reset()}}let Ae={VertexFormat:y,IndexBuffer:X,VertexBuffer:v,Program:O,Texture:w,Texture2D:W,TextureCube:Y,RenderBuffer:V,FrameBuffer:q,Device:Re,attrTypeBytes:D,glFilter:C,glTextureFmt:I};Object.assign(Ae,g);return Ae}();
//# sourceMappingURL=gfx.min.js.map