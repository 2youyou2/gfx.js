var gfx=function(){"use strict";const e=9728;const t=9729;const i=9984;const n=9985;const s=9986;const r=9987;const l=5121;const _=5123;const a=5125;const c=5126;const o=33635;const f=32819;const T=32820;const h=36193;const u=6402;const E=6406;const p=6407;const d=6408;const F=6409;const R=6410;const m=33776;const A=33777;const S=33778;const B=33779;const x=35840;const b=35841;const P=35842;const N=35843;const U=36196;const M=[[e,i,s],[t,n,r]];const O=[{format:p,internalFormat:m,pixelType:null},{format:d,internalFormat:A,pixelType:null},{format:d,internalFormat:S,pixelType:null},{format:d,internalFormat:B,pixelType:null},{format:p,internalFormat:U,pixelType:null},{format:p,internalFormat:b,pixelType:null},{format:d,internalFormat:N,pixelType:null},{format:p,internalFormat:x,pixelType:null},{format:d,internalFormat:P,pixelType:null},{format:E,internalFormat:E,pixelType:l},{format:F,internalFormat:F,pixelType:l},{format:R,internalFormat:R,pixelType:l},{format:p,internalFormat:p,pixelType:o},{format:d,internalFormat:d,pixelType:T},{format:d,internalFormat:d,pixelType:f},{format:p,internalFormat:p,pixelType:l},{format:d,internalFormat:d,pixelType:l},{format:p,internalFormat:p,pixelType:h},{format:d,internalFormat:d,pixelType:h},{format:p,internalFormat:p,pixelType:c},{format:d,internalFormat:d,pixelType:c},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:u,internalFormat:u,pixelType:_},{format:u,internalFormat:u,pixelType:a},{format:null,internalFormat:null,pixelType:null}];let L={USAGE_STATIC:35044,USAGE_DYNAMIC:35048,USAGE_STREAM:35040,INDEX_FMT_UINT8:5121,INDEX_FMT_UINT16:5123,INDEX_FMT_UINT32:5125,ATTR_POSITION:"a_position",ATTR_NORMAL:"a_normal",ATTR_TANGENT:"a_tangent",ATTR_BITANGENT:"a_bitangent",ATTR_WEIGHT:"a_weight",ATTR_INDICES:"a_indices",ATTR_COLOR:"a_color",ATTR_COLOR0:"a_color0",ATTR_COLOR1:"a_color1",ATTR_UV:"a_uv",ATTR_UV0:"a_uv0",ATTR_UV1:"a_uv1",ATTR_UV2:"a_uv2",ATTR_UV3:"a_uv3",ATTR_UV4:"a_uv4",ATTR_UV5:"a_uv5",ATTR_UV6:"a_uv6",ATTR_UV7:"a_uv7",ATTR_TYPE_INT8:5120,ATTR_TYPE_UINT8:5121,ATTR_TYPE_INT16:5122,ATTR_TYPE_UINT16:5123,ATTR_TYPE_INT32:5124,ATTR_TYPE_UINT32:5125,ATTR_TYPE_FLOAT32:5126,FILTER_NEAREST:0,FILTER_LINEAR:1,WRAP_REPEAT:10497,WRAP_CLAMP:33071,WRAP_MIRROR:33648,TEXTURE_FMT_RGB_DXT1:0,TEXTURE_FMT_RGBA_DXT1:1,TEXTURE_FMT_RGBA_DXT3:2,TEXTURE_FMT_RGBA_DXT5:3,TEXTURE_FMT_RGB_ETC1:4,TEXTURE_FMT_RGB_PVRTC_2BPPV1:5,TEXTURE_FMT_RGBA_PVRTC_2BPPV1:6,TEXTURE_FMT_RGB_PVRTC_4BPPV1:7,TEXTURE_FMT_RGBA_PVRTC_4BPPV1:8,TEXTURE_FMT_A8:9,TEXTURE_FMT_L8:10,TEXTURE_FMT_L8_A8:11,TEXTURE_FMT_R5_G6_B5:12,TEXTURE_FMT_R5_G5_B5_A1:13,TEXTURE_FMT_R4_G4_B4_A4:14,TEXTURE_FMT_RGB8:15,TEXTURE_FMT_RGBA8:16,TEXTURE_FMT_RGB16F:17,TEXTURE_FMT_RGBA16F:18,TEXTURE_FMT_RGB32F:19,TEXTURE_FMT_RGBA32F:20,TEXTURE_FMT_R32F:21,TEXTURE_FMT_111110F:22,TEXTURE_FMT_SRGB:23,TEXTURE_FMT_SRGBA:24,TEXTURE_FMT_D16:25,TEXTURE_FMT_D32:26,TEXTURE_FMT_D24S8:27,DS_FUNC_NEVER:512,DS_FUNC_LESS:513,DS_FUNC_EQUAL:514,DS_FUNC_LEQUAL:515,DS_FUNC_GREATER:516,DS_FUNC_NOTEQUAL:517,DS_FUNC_GEQUAL:518,DS_FUNC_ALWAYS:519,RB_FMT_RGBA4:32854,RB_FMT_RGB5_A1:32855,RB_FMT_RGB565:36194,RB_FMT_D16:33189,RB_FMT_S8:36168,RB_FMT_D24S8:34041,BLEND_FUNC_ADD:32774,BLEND_FUNC_SUBTRACT:32778,BLEND_FUNC_REVERSE_SUBTRACT:32779,BLEND_ZERO:0,BLEND_ONE:1,BLEND_SRC_COLOR:768,BLEND_ONE_MINUS_SRC_COLOR:769,BLEND_DST_COLOR:774,BLEND_ONE_MINUS_DST_COLOR:775,BLEND_SRC_ALPHA:770,BLEND_ONE_MINUS_SRC_ALPHA:771,BLEND_DST_ALPHA:772,BLEND_ONE_MINUS_DST_ALPHA:773,BLEND_CONSTANT_COLOR:32769,BLEND_ONE_MINUS_CONSTANT_COLOR:32770,BLEND_CONSTANT_ALPHA:32771,BLEND_ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_SRC_ALPHA_SATURATE:776,STENCIL_OP_KEEP:7680,STENCIL_OP_ZERO:0,STENCIL_OP_REPLACE:7681,STENCIL_OP_INCR:7682,STENCIL_OP_INCR_WRAP:34055,STENCIL_OP_DECR:7683,STENCIL_OP_DECR_WRAP:34056,STENCIL_OP_INVERT:5386,CULL_NONE:0,CULL_FRONT:1028,CULL_BACK:1029,CULL_FRONT_AND_BACK:1032,PT_POINTS:0,PT_LINES:1,PT_LINE_LOOP:2,PT_LINE_STRIP:3,PT_TRIANGLES:4,PT_TRIANGLE_STRIP:5,PT_TRIANGLE_FAN:6};function g(e){if(e===L.ATTR_TYPE_INT8){return 1}else if(e===L.ATTR_TYPE_UINT8){return 1}else if(e===L.ATTR_TYPE_INT16){return 2}else if(e===L.ATTR_TYPE_UINT16){return 2}else if(e===L.ATTR_TYPE_INT32){return 4}else if(e===L.ATTR_TYPE_UINT32){return 4}else if(e===L.ATTR_TYPE_FLOAT32){return 4}console.warn(`Unknown ATTR_TYPE: ${e}`);return 0}function D(e,t,i=-1){let n=M[t][i+1];if(n===undefined){console.warn(`Unknown FILTER: ${t}`);return i===-1?e.LINEAR:e.LINEAR_MIPMAP_LINEAR}return n}function I(e){let t=O[e];if(t===undefined){console.warn(`Unknown TEXTURE_FMT: ${e}`);return O[L.TEXTURE_FMT_RGBA8]}return t}class C{constructor(e){this._attr2el={};this._elements=[];this._bytes=0;let t=0;for(let i=0,n=e.length;i<n;++i){let n=e[i];let s={name:n.name,offset:t,stride:0,stream:-1,type:n.type,num:n.num,normalize:n.normalize===undefined?false:n.normalize,bytes:n.num*g(n.type)};this._attr2el[s.name]=s;this._elements.push(s);this._bytes+=s.bytes;t+=s.bytes}for(let e=0,t=this._elements.length;e<t;++e){let t=this._elements[e];t.stride=this._bytes}}element(e){return this._attr2el[e]}}class k{constructor(e,t,i,n,s,r){this._device=e;this._format=t;this._usage=i;this._persist=r;this._numIndices=s;let l=0;if(t===L.INDEX_FMT_UINT8){l=s}else if(t===L.INDEX_FMT_UINT16){l=2*s}else if(t===L.INDEX_FMT_UINT32){l=4*s}this._bytes=l;this._glID=e._gl.createBuffer();this._data=null;this.update(0,n);e._stats.ib+=l}destroy(){if(this._glID===-1){console.error("The buffer already destroyed");return}let e=this.device.gl;e.deleteBuffer(this._glID);this.device._stats.ib-=this.bytes;this._glID=-1}update(e,t){if(this._glID===-1){console.error("The buffer is destroyed");return}if(t&&t.byteLength+e>this._bytes){console.error("Failed to update data, bytes exceed.");return}let i=this._device._gl;let n=this._usage;i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._glID);if(!t){i.bufferData(i.ELEMENT_ARRAY_BUFFER,this._bytes,n)}else{if(e){i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,t,n)}else{i.bufferData(i.ELEMENT_ARRAY_BUFFER,t,n)}}i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);if(this._persist){if(this._data){this._data.set(t,e)}else{this._data=t}}}get count(){return this._numIndices}}class v{constructor(e,t,i,n,s,r){this._device=e;this._format=t;this._usage=i;this._persist=r;this._numVertices=s;this._bytes=this._format._bytes*s;this._glID=e._gl.createBuffer();this._data=null;this.update(0,n);e._stats.vb+=this._bytes}destroy(){if(this._glID===-1){console.error("The buffer already destroyed");return}let e=this.device.gl;e.deleteBuffer(this._glID);this.device._stats.vb-=this.bytes;this._glID=-1}update(e,t){if(this._glID===-1){console.error("The buffer is destroyed");return}if(t&&t.byteLength+e>this._bytes){console.error("Failed to update data, bytes exceed.");return}let i=this._device._gl;let n=this._usage;i.bindBuffer(i.ARRAY_BUFFER,this._glID);if(!t){i.bufferData(i.ARRAY_BUFFER,this._bytes,n)}else{if(e){i.bufferSubData(i.ARRAY_BUFFER,t,n)}else{i.bufferData(i.ARRAY_BUFFER,t,n)}}i.bindBuffer(i.ARRAY_BUFFER,null);if(this._persist){if(this._data){this._data.set(t,e)}else{this._data=t}}}get count(){return this._numVertices}}let y=0;class X{constructor(e,t){this._device=e;this._attributes=[];this._uniforms=[];this._samplers=[];this._linked=false;this._vertSource=t.vert;this._fragSource=t.frag;this._glID=null;this._id=y++}get id(){return this._id}link(){if(this._linked){return}let e=this._device._gl;let t=W(e,e.VERTEX_SHADER,this._vertSource);let i=W(e,e.FRAGMENT_SHADER,this._fragSource);let n=e.createProgram();e.attachShader(n,t);e.attachShader(n,i);e.linkProgram(n);let s=false;if(!e.getShaderParameter(t,e.COMPILE_STATUS)){console.error(`Failed to compile vertex shader: ${e.getShaderInfoLog(t)}`);s=true}if(!e.getShaderParameter(i,e.COMPILE_STATUS)){console.error(`Failed to compile fragment shader: ${e.getShaderInfoLog(i)}`);s=true}if(!e.getProgramParameter(n,e.LINK_STATUS)){console.error(`Failed to link shader program: ${e.getProgramInfoLog(n)}`);s=true}e.deleteShader(t);e.deleteShader(i);if(s){return}this._glID=n;let r=e.getProgramParameter(n,e.ACTIVE_ATTRIBUTES);for(let t=0;t<r;++t){let i=e.getActiveAttrib(n,t);let s=e.getAttribLocation(n,i.name);this._attributes.push({name:i.name,location:s,type:i.type})}let l=e.getProgramParameter(n,e.ACTIVE_UNIFORMS);for(let t=0;t<l;++t){let i=e.getActiveUniform(n,t);let s=e.getUniformLocation(n,i.name);this._uniforms.push({name:i.name,location:s,type:i.type})}this._linked=true}destroy(){let e=this._device._gl;e.deleteProgram(this._glID);this._linked=false;this._glID=null;this._attributes=[];this._uniforms=[];this._samplers=[]}}function W(e,t,i){let n=e.createShader(t);e.shaderSource(n,i);e.compileShader(n);return n}class G{constructor(e){this._device=e;this._width=4;this._height=4;this._hasMipmap=false;this._compressed=false;this._anisotropy=1;this._minFilter=L.FILTER_LINEAR;this._magFilter=L.FILTER_LINEAR;this._mipFilter=L.FILTER_LINEAR;this._wrapS=L.WRAP_REPEAT;this._wrapT=L.WRAP_REPEAT;this._format=L.TEXTURE_FMT_RGBA8;this._target=-1}destroy(){if(this._glID===-1){console.error("The texture already destroyed");return}let e=this.device.gl;e.deleteTexture(this._glID);this.device._stats.tex-=this.bytes;this._glID=-1}}function w(e){return!(e&e-1)&&!!e}class Y extends G{constructor(e,t){super(e);this._target=this._device._gl.TEXTURE_2D;this.update(t)}update(e){let t=this._device._gl;let i=this._hasMipmap;if(e){if(e.width!==undefined){this._width=e.width}if(e.height!==undefined){this._height=e.height}if(e.anisotropy!==undefined){this._anisotropy=e.anisotropy}if(e.minFilter!==undefined){this._minFilter=e.minFilter}if(e.magFilter!==undefined){this._magFilter=e.magFilter}if(e.mipFilter!==undefined){this._mipFilter=e.mipFilter}if(e.wrapS!==undefined){this._wrapS=e.wrapS}if(e.wrapT!==undefined){this._wrapT=e.wrapT}if(e.format!==undefined){this._format=e.format;this._compressed=this._format>=L.TEXTURE_FMT_RGB_DXT1&&this._format<=L.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(e.mipmap!==undefined){this._hasMipmap=e.mipmap;i=e.mipmap}if(e.images!==undefined){if(e.images.length>1){i=false}}}this._glID=t.createTexture();t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,this._glID);let n=e.images||[null];this._setMipmap(n,e.flipY,e.premultiplyAlpha);this._setTexInfo();if(i){t.hint(t.GENERATE_MIPMAP_HINT,t.NICEST);t.generateMipmap(t.TEXTURE_2D)}this._device._restoreTexture(0)}_setMipmap(e,t,i){let n=this._device._gl;let s=I(this._format);for(let r=0;r<e.length;++r){let l=e[r];if(l instanceof HTMLCanvasElement||l instanceof HTMLImageElement||l instanceof HTMLVideoElement){if(t===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,true)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}n.texImage2D(n.TEXTURE_2D,r,s.internalFormat,s.format,s.pixelType,l)}else{if(t===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}if(this._compressed){n.compressedTexImage2D(n.TEXTURE_2D,r,s.internalFormat,this._width,this._height,0,l)}else{n.texImage2D(n.TEXTURE_2D,r,s.internalFormat,this._width,this._height,0,s.format,s.pixelType,l)}}}}_setTexInfo(){let e=this._device._gl;let t=w(this._width)&&w(this._height);if(!t&&(this._wrapS!==L.WRAP_CLAMP||this._wrapT!==L.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=L.WRAP_CLAMP;this._wrapT=L.WRAP_CLAMP}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,D(e,this._minFilter,this._hasMipmap?this._mipFilter:-1));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,D(e,this._magFilter,-1));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this._wrapS);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this._wrapT);let i=this._device.ext("EXT_texture_filter_anisotropic");if(i){e.texParameteri(e.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}}}class z extends G{constructor(e,t){super(e);this._target=this._device._gl.TEXTURE_CUBE_MAP;this.update(t)}update(e){let t=this._device._gl;let i=this._hasMipmap;if(e){if(e.width!==undefined){this._width=e.width}if(e.height!==undefined){this._height=e.height}if(e.anisotropy!==undefined){this._anisotropy=e.anisotropy}if(e.minFilter!==undefined){this._minFilter=e.minFilter}if(e.magFilter!==undefined){this._magFilter=e.magFilter}if(e.mipFilter!==undefined){this._mipFilter=e.mipFilter}if(e.wrapS!==undefined){this._wrapS=e.wrapS}if(e.wrapT!==undefined){this._wrapT=e.wrapT}if(e.format!==undefined){this._format=e.format;this._compressed=this._format>=L.TEXTURE_FMT_RGB_DXT1&&this._format<=L.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(e.mipmap!==undefined){this._hasMipmap=e.mipmap;i=e.mipmap}if(e.images!==undefined){if(e.images.length>1){i=false}}}this._glID=t.createTexture();t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_CUBE_MAP,this._glID);if(e.images!==undefined){this._setMipmap(e.images,e.flipY,e.premultiplyAlpha)}this._setTexInfo();if(i){t.hint(t.GENERATE_MIPMAP_HINT,t.NICEST);t.generateMipmap(t.TEXTURE_CUBE_MAP)}this._device._restoreTexture(0)}_setMipmap(e,t,i){let n=this._device._gl;let s=I(this._format);if(t===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}for(let t=0;t<e.length;++t){let i=e[t];for(let e=0;e<6;++e){if(i[e]instanceof HTMLCanvasElement||i[e]instanceof HTMLImageElement||i[e]instanceof HTMLVideoElement){n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,s.internalFormat,s.format,s.pixelType,i[e])}else{if(this._compressed){n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,s.internalFormat,this._width,this._height,0,i[e])}else{n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,s.internalFormat,this._width,this._height,0,s.format,s.pixelType,i[e])}}}}}_setTexInfo(){let e=this._device._gl;e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,D(e,this._minFilter,this._hasMipmap?this._mipFilter:-1));e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,D(e,this._magFilter,-1));e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,this._wrapS);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,this._wrapT);let t=this._device.ext("EXT_texture_filter_anisotropic");if(t){e.texParameteri(e.TEXTURE_CUBE_MAP,t.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}}}class V{constructor(e,t,i,n){this._device=e;this._format=t;this._width=i;this._height=n;const s=e._gl;this._glID=s.createRenderbuffer();s.bindRenderbuffer(s.RENDERBUFFER,this._glID);s.renderbufferStorage(s.RENDERBUFFER,t,i,n);s.bindRenderbuffer(s.RENDERBUFFER,null)}destroy(){if(this._glID===null){console.error("The render-buffer already destroyed");return}const e=this._device._gl;e.bindRenderbuffer(e.RENDERBUFFER,null);e.deleteRenderbuffer(this._glID);this._glID=null}}class H{constructor(e,t,i,n){this._device=e;this._width=t;this._height=i;this._colors=n.colors||[];this._depth=n.depth||null;this._stencil=n.stencil||null;this._depthStencil=n.depthStencil||null;this._glID=e._gl.createFramebuffer()}destroy(){if(this._glID===null){console.error("The frame-buffer already destroyed");return}const e=this._device._gl;e.deleteFramebuffer(this._glID);this._glID=null}}const K={blend:false,blendSep:false,blendColor:4294967295,blendEq:L.BLEND_FUNC_ADD,blendAlphaEq:L.BLEND_FUNC_ADD,blendSrc:L.BLEND_ONE,blendDst:L.BLEND_ZERO,blendSrcAlpha:L.BLEND_ONE,blendDstAlpha:L.BLEND_ZERO,depthTest:false,depthWrite:false,depthFunc:L.DS_FUNC_LESS,stencilTest:false,stencilSep:false,stencilFuncFront:L.DS_FUNC_ALWAYS,stencilRefFront:0,stencilMaskFront:255,stencilFailOpFront:L.STENCIL_OP_KEEP,stencilZFailOpFront:L.STENCIL_OP_KEEP,stencilZPassOpFront:L.STENCIL_OP_KEEP,stencilWriteMaskFront:255,stencilFuncBack:L.DS_FUNC_ALWAYS,stencilRefBack:0,stencilMaskBack:255,stencilFailOpBack:L.STENCIL_OP_KEEP,stencilZFailOpBack:L.STENCIL_OP_KEEP,stencilZPassOpBack:L.STENCIL_OP_KEEP,stencilWriteMaskBack:255,cullMode:L.CULL_BACK,primitiveType:L.PT_TRIANGLES,maxStream:-1,vertexBuffers:[],vertexBufferOffsets:[],indexBuffer:null,textureUnits:[],program:null};class q{constructor(){this.vertexBuffers=[];this.vertexBufferOffsets=[];this.textureUnits=[];this.set(K)}reset(){this.set(K)}set(e){this.blend=e.blend;this.blendSep=e.blendSep;this.blendColor=e.blendColor;this.blendEq=e.blendEq;this.blendAlphaEq=e.blendAlphaEq;this.blendSrc=e.blendSrc;this.blendDst=e.blendDst;this.blendSrcAlpha=e.blendSrcAlpha;this.blendDstAlpha=e.blendDstAlpha;this.depthTest=e.depthTest;this.depthWrite=e.depthWrite;this.depthFunc=e.depthFunc;this.stencilTest=e.stencilTest;this.stencilSep=e.stencilSep;this.stencilFuncFront=e.stencilFuncFront;this.stencilRefFront=e.stencilRefFront;this.stencilMaskFront=e.stencilMaskFront;this.stencilFailOpFront=e.stencilFailOpFront;this.stencilZFailOpFront=e.stencilZFailOpFront;this.stencilZPassOpFront=e.stencilZPassOpFront;this.stencilWriteMaskFront=e.stencilWriteMaskFront;this.stencilFuncBack=e.stencilFuncBack;this.stencilRefBack=e.stencilRefBack;this.stencilMaskBack=e.stencilMaskBack;this.stencilFailOpBack=e.stencilFailOpBack;this.stencilZFailOpBack=e.stencilZFailOpBack;this.stencilZPassOpBack=e.stencilZPassOpBack;this.stencilWriteMaskBack=e.stencilWriteMaskBack;this.cullMode=e.cullMode;this.primitiveType=e.primitiveType;this.maxStream=e.maxStream;for(let t=0;t<e.vertexBuffers.length;++t){this.vertexBuffers[t]=e.vertexBuffers[t]}for(let t=0;t<e.vertexBufferOffsets.length;++t){this.vertexBufferOffsets[t]=e.vertexBufferOffsets[t]}this.indexBuffer=e.indexBuffer;for(let t=0;t<e.textureUnits.length;++t){this.textureUnits[t]=e.textureUnits[t]}this.program=e.program}}const Z=5124;const Q=5126;const j=35664;const J=35665;const $=35666;const ee=35667;const te=35668;const ie=35669;const ne=35670;const se=35671;const re=35672;const le=35673;const _e=35674;const ae=35675;const ce=35676;const oe=35678;const fe=35680;let Te={[Z]:function(e,t,i){e.uniform1i(t,i)},[Q]:function(e,t,i){e.uniform1f(t,i)},[j]:function(e,t,i){e.uniform2fv(t,i)},[J]:function(e,t,i){e.uniform3fv(t,i)},[$]:function(e,t,i){e.uniform4fv(t,i)},[ee]:function(e,t,i){e.uniform2iv(t,i)},[te]:function(e,t,i){e.uniform3iv(t,i)},[ie]:function(e,t,i){e.uniform4iv(t,i)},[ne]:function(e,t,i){e.uniform1i(t,i)},[se]:function(e,t,i){e.uniform2iv(t,i)},[re]:function(e,t,i){e.uniform3iv(t,i)},[le]:function(e,t,i){e.uniform4iv(t,i)},[_e]:function(e,t,i){e.uniformMatrix2fv(t,false,i)},[ae]:function(e,t,i){e.uniformMatrix3fv(t,false,i)},[ce]:function(e,t,i){e.uniformMatrix4fv(t,false,i)},[oe]:function(e,t,i){e.uniform1i(t,i)},[fe]:function(e,t,i){e.uniform1i(t,i)}};function he(e,t,i){if(t.blend!==i.blend){if(!i.blend){e.disable(e.BLEND);return}e.enable(e.BLEND);if(i.blendSrc===L.BLEND_CONSTANT_COLOR||i.blendSrc===L.BLEND_ONE_MINUS_CONSTANT_COLOR||i.blendDst===L.BLEND_CONSTANT_COLOR||i.blendDst===L.BLEND_ONE_MINUS_CONSTANT_COLOR){e.blendColor((i.blendColor>>24)/255,(i.blendColor>>16&255)/255,(i.blendColor>>8&255)/255,(i.blendColor&255)/255)}if(i.blendSep){e.blendFuncSeparate(i.blendSrc,i.blendDst,i.blendSrcAlpha,i.blendDstAlpha);e.blendEquationSeparate(i.blendEq,i.blendAlphaEq)}else{e.blendFunc(i.blendSrc,i.blendDst);e.blendEquation(i.blendEq)}return}if(i.blend===false){return}if(t.blendColor!==i.blendColor){e.blendColor((i.blendColor>>24)/255,(i.blendColor>>16&255)/255,(i.blendColor>>8&255)/255,(i.blendColor&255)/255)}if(t.blendSep!==i.blendSep){if(i.blendSep){e.blendFuncSeparate(i.blendSrc,i.blendDst,i.blendSrcAlpha,i.blendDstAlpha);e.blendEquationSeparate(i.blendEq,i.blendAlphaEq)}else{e.blendFunc(i.blendSrc,i.blendDst);e.blendEquation(i.blendEq)}return}if(i.blendSep){if(t.blendSrc!==i.blendSrc||t.blendDst!==i.blendDst||t.blendSrcAlpha!==i.blendSrcAlpha||t.blendDstAlpha!==i.blendDstAlpha){e.blendFuncSeparate(i.blendSrc,i.blendDst,i.blendSrcAlpha,i.blendDstAlpha)}if(t.blendEq!==i.blendEq||t.blendAlphaEq!==i.blendAlphaEq){e.blendEquationSeparate(i.blendEq,i.blendAlphaEq)}}else{if(t.blendSrc!==i.blendSrc||t.blendDst!==i.blendDst){e.blendFunc(i.blendSrc,i.blendDst)}if(t.blendEq!==i.blendEq){e.blendEquation(i.blendEq)}}}function ue(e,t,i){if(t.depthTest!==i.depthTest){if(!i.depthTest){e.disable(e.DEPTH_TEST);return}e.enable(e.DEPTH_TEST);e.depthFunc(i.depthFunc);e.depthMask(i.depthWrite);return}if(t.depthWrite!==i.depthWrite){e.depthMask(i.depthWrite)}if(i.depthTest===false){if(i.depthWrite){i.depthTest=true;i.depthFunc=L.DS_FUNC_ALWAYS;e.enable(e.DEPTH_TEST);e.depthFunc(i.depthFunc)}return}if(t.depthFunc!==i.depthFunc){e.depthFunc(i.depthFunc)}}function Ee(e,t,i){if(i.stencilTest!==t.stencilTest){if(!i.stencilTest){e.disable(e.STENCIL_TEST);return}e.enable(e.STENCIL_TEST);if(i.stencilSep){e.stencilFuncSeparate(e.FRONT,i.stencilFuncFront,i.stencilRefFront,i.stencilMaskFront);e.stencilMaskSeparate(e.FRONT,i.stencilWriteMaskFront);e.stencilOpSeparate(e.FRONT,i.stencilFailOpFront,i.stencilzFailOpFront,i.stencilzPassOpFront);e.stencilFuncSeparate(e.BACK,i.stencilFuncBack,i.stencilRefBack,i.stencilMaskBack);e.stencilMaskSeparate(e.BACK,i.stencilWriteMaskBack);e.stencilOpSeparate(e.BACK,i.stencilFailOpBack,i.stencilzFailOpBack,i.stencilzPassOpBack)}else{e.stencilFunc(i.stencilFuncFront,i.stencilRefFront,i.stencilMaskFront);e.stencilMask(i.stencilWriteMaskFront);e.stencilOp(i.stencilFailOpFront,i.stencilzFailOpFront,i.stencilzPassOpFront)}return}if(!i.stencilTest){return}if(t.stencilSep!==i.stencilSep){if(i.stencilSep){e.stencilFuncSeparate(e.FRONT,i.stencilFuncFront,i.stencilRefFront,i.stencilMaskFront);e.stencilMaskSeparate(e.FRONT,i.stencilWriteMaskFront);e.stencilOpSeparate(e.FRONT,i.stencilFailOpFront,i.stencilzFailOpFront,i.stencilzPassOpFront);e.stencilFuncSeparate(e.BACK,i.stencilFuncBack,i.stencilRefBack,i.stencilMaskBack);e.stencilMaskSeparate(e.BACK,i.stencilWriteMaskBack);e.stencilOpSeparate(e.BACK,i.stencilFailOpBack,i.stencilzFailOpBack,i.stencilzPassOpBack)}else{e.stencilFunc(i.stencilFuncFront,i.stencilRefFront,i.stencilMaskFront);e.stencilMask(i.stencilWriteMaskFront);e.stencilOp(i.stencilFailOpFront,i.stencilzFailOpFront,i.stencilzPassOpFront)}return}if(i.stencilSep){if(t.stencilFuncFront!==i.stencilFuncFront||t.stencilRefFront!==i.stencilRefFront||t.stencilMaskFront!==i.stencilMaskFront){e.stencilFuncSeparate(e.FRONT,i.stencilFuncFront,i.stencilRefFront,i.stencilMaskFront)}if(t.stencilWriteMaskFront!==i.stencilWriteMaskFront){e.stencilMaskSeparate(e.FRONT,i.stencilWriteMaskFront)}if(t.stencilFailOpFront!==i.stencilFailOpFront||t.stencilzFailOpFront!==i.stencilzFailOpFront||t.stencilzPassOpFront!==i.stencilzPassOpFront){e.stencilOpSeparate(e.FRONT,i.stencilFailOpFront,i.stencilzFailOpFront,i.stencilzPassOpFront)}if(t.stencilFuncBack!==i.stencilFuncBack||t.stencilRefBack!==i.stencilRefBack||t.stencilMaskBack!==i.stencilMaskBack){e.stencilFuncSeparate(e.BACK,i.stencilFuncBack,i.stencilRefBack,i.stencilMaskBack)}if(t.stencilWriteMaskBack!==i.stencilWriteMaskBack){e.stencilMaskSeparate(e.BACK,i.stencilWriteMaskBack)}if(t.stencilFailOpBack!==i.stencilFailOpBack||t.stencilzFailOpBack!==i.stencilzFailOpBack||t.stencilzPassOpBack!==i.stencilzPassOpBack){e.stencilOpSeparate(e.BACK,i.stencilFailOpBack,i.stencilzFailOpBack,i.stencilzPassOpBack)}}else{if(t.stencilFuncFront!==i.stencilFuncFront||t.stencilRefFront!==i.stencilRefFront||t.stencilMaskFront!==i.stencilMaskFront){e.stencilFunc(i.stencilFuncFront,i.stencilRefFront,i.stencilMaskFront)}if(t.stencilWriteMaskFront!==i.stencilWriteMaskFront){e.stencilMask(i.stencilWriteMaskFront)}if(t.stencilFailOpFront!==i.stencilFailOpFront||t.stencilzFailOpFront!==i.stencilzFailOpFront||t.stencilzPassOpFront!==i.stencilzPassOpFront){e.stencilOp(i.stencilFailOpFront,i.stencilzFailOpFront,i.stencilzPassOpFront)}}}function pe(e,t,i){if(t.cullMode===i.cullMode){return}if(i.cullMode===L.CULL_NONE){e.disable(e.CULL_FACE);return}e.enable(e.CULL_FACE);e.cullFace(i.cullMode)}function de(e,t,i){let n=false;if(t.maxStream!==i.maxStream){n=true}else if(t.program!==i.program){n=true}else{for(let e=0;e<i.maxStream+1;++e){if(t.vertexBuffers[e]!==i.vertexBuffers[e]||t.vertexBufferOffsets[e]!==i.vertexBufferOffsets[e]){n=true;break}}}if(n){for(let t=0;t<i.maxStream+1;++t){let n=i.vertexBuffers[t];let s=i.vertexBufferOffsets[t];if(!n){continue}e.bindBuffer(e.ARRAY_BUFFER,n._glID);for(let t=0;t<i.program._attributes.length;++t){let r=i.program._attributes[t];let l=n._format.element(r.name);if(!l){console.warn(`Can not find vertex attribute: ${r.name}`);continue}e.enableVertexAttribArray(r.location);e.vertexAttribPointer(r.location,l.num,l.type,l.normalize,l.stride,l.offset+s*l.stride)}}}}function Fe(e,t,i){for(let n=0;n<i.textureUnits.length;++n){if(t.textureUnits[n]!==i.textureUnits[n]){let t=i.textureUnits[n];e.bindTexture(t._target,t._glID)}}}function Re(e,t,i,n=0){if(i instanceof Y){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_2D,i._glID,0)}else if(i instanceof z){e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,i._glID,0)}else{e.framebufferRenderbuffer(e.FRAMEBUFFER,t,e.RENDERBUFFER,i._glID)}}class me{constructor(e,t){let i;t=t||{};if(t.alpha===undefined){t.alpha=false}if(t.stencil===undefined){t.stencil=true}if(t.depth===undefined){t.depth=true}try{i=e.getContext("webgl",t)}catch(e){console.error(e);return}this._gl=i;this._extensions={};this._caps={};this._stats={texture:0,vb:0,ib:0,drawcalls:0};this._current=new q;this._next=new q;this._uniforms={};this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0;this._framebuffer=null;this._initExtensions(["EXT_texture_filter_anisotropic","OES_standard_derivatives","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","WEBGL_draw_buffers"]);this._initCaps();this._initStates()}_initExtensions(e){const t=this._gl;for(let i=0;i<e.length;++i){let n=e[i];try{let e=t.getExtension(n);if(e){this._extensions[n]=e}}catch(e){console.error(e)}}}_initCaps(){const e=this._gl;const t=this.ext("WEBGL_draw_buffers");this._caps.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxFragUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxDrawBuffers=t?e.getParameter(t.MAX_DRAW_BUFFERS_WEBGL):1;this._caps.maxColorAttachments=t?e.getParameter(t.MAX_COLOR_ATTACHMENTS_WEBGL):1}_initStates(){const e=this._gl;e.disable(e.BLEND);e.blendFunc(e.ONE,e.ZERO);e.blendEquation(e.FUNC_ADD);e.blendColor(1,1,1,1);e.colorMask(true,true,true,true);e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.disable(e.DEPTH_TEST);e.depthFunc(e.LESS);e.depthMask(false);e.disable(e.POLYGON_OFFSET_FILL);e.depthRange(0,1);e.disable(e.STENCIL_TEST);e.stencilFunc(e.ALWAYS,0,255);e.stencilMask(255);e.stencilOp(e.KEEP,e.KEEP,e.KEEP);e.clearDepth(1);e.clearColor(0,0,0,0);e.clearStencil(0);e.disable(e.SCISSOR_TEST)}_restoreTexture(e){const t=this._gl;let i=this._current.textureUnits[e];if(i){t.bindTexture(i._target,i._glID)}else{t.bindTexture(t.TEXTURE_2D,null)}}ext(e){return this._extensions[e]}setFrameBuffer(e){if(this._framebuffer===e){return}this._framebuffer=e;const t=this._gl;if(e===null){t.bindFramebuffer(t.FRAMEBUFFER,null);return}t.bindFramebuffer(t.FRAMEBUFFER,e._glID);let i=this._framebuffer._colors.length;for(let e=0;e<i;++e){let i=this._framebuffer._colors[e];Re(t,t.COLOR_ATTACHMENT0+e,i)}for(let e=i;e<this._caps.maxColorAttachments;++e){t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0)}if(this._framebuffer._depth){Re(t,t.DEPTH_ATTACHMENT,this._framebuffer._depth)}if(this._framebuffer._stencil){Re(t,t.STENCIL_ATTACHMENT,e._stencil)}if(this._framebuffer._depthStencil){Re(t,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencil)}}setViewport(e,t,i,n){if(this._vx!==e||this._vy!==t||this._vw!==i||this._vh!==n){this._gl.viewport(e,t,i,n);this._vx=e;this._vy=t;this._vw=i;this._vh=n}}setScissor(e,t,i,n){if(this._sx!==e||this._sy!==t||this._sw!==i||this._sh!==n){this._gl.scissor(e,t,i,n);this._sx=e;this._sy=t;this._sw=i;this._sh=n}}clear(e){const t=this._gl;let i=0;if(e.color!==undefined){i|=t.COLOR_BUFFER_BIT;t.clearColor(e.color[0],e.color[1],e.color[2],e.color[3])}if(e.depth!==undefined){i|=t.DEPTH_BUFFER_BIT;t.clearDepth(e.depth);t.enable(t.DEPTH_TEST);t.depthMask(true);t.depthFunc(t.ALWAYS)}if(e.stencil!==undefined){i|=t.STENCIL_BUFFER_BIT;t.clearStencil(e.stencil)}t.clear(i);if(e.depth!==undefined){if(this._current.depthTest===false){t.disable(t.DEPTH_TEST)}else{if(this._current.depthWrite===false){t.depthMask(false)}if(this._current.depthFunc!==L.DS_FUNC_ALWAYS){t.depthFunc(this._current.depthFunc)}}}}enableBlend(){this._next.blend=true}enableDepthTest(){this._next.depthTest=true}enableDepthWrite(){this._next.depthWrite=true}enableStencilTest(){this._next.stencilTest=true}setStencilFunc(e,t,i){this._next.stencilSep=false;this._next.stencilFuncFront=this._next.stencilFuncBack=e;this._next.stencilRefFront=this._next.stencilRefBack=t;this._next.stencilMaskFront=this._next.stencilMaskBack=i}setStencilFuncFront(e,t,i){this._next.stencilSep=true;this._next.stencilFuncFront=e;this._next.stencilRefFront=t;this._next.stencilMaskFront=i}setStencilFuncBack(e,t,i){this._next.stencilSep=true;this._next.stencilFuncBack=e;this._next.stencilRefBack=t;this._next.stencilMaskBack=i}setStencilOp(e,t,i,n){this._next.stencilFailOpFront=this._next.stencilFailOpBack=e;this._next.stencilzFailOpFront=this._next.stencilzFailOpBack=t;this._next.stencilzPassOpFront=this._next.stencilzPassOpBack=i;this._next.stencilWriteMaskFront=this._next.stencilWriteMaskBack=n}setStencilOpFront(e,t,i,n){this._next.stencilSep=true;this._next.stencilFailOpFront=e;this._next.stencilzFailOpFront=t;this._next.stencilzPassOpFront=i;this._next.stencilWriteMaskFront=n}setStencilOpBack(e,t,i,n){this._next.stencilSep=true;this._next.stencilFailOpBack=e;this._next.stencilzFailOpBack=t;this._next.stencilzPassOpBack=i;this._next.stencilWriteMaskBack=n}setDepthFunc(e){this._next.depthFunc=e}setBlendColor(e,t,i,n){this._next.blendColor=(e*255<<24|t*255<<16|i*255<<8|n*255)>>>0}setBlendFunc(e,t){this._next.blendSep=false;this._next.blendSrc=e;this._next.blendDst=t}setBlendFuncSep(e,t,i,n){this._next.blendSep=true;this._next.blendSrc=e;this._next.blendDst=t;this._next.blendSrcAlpha=i;this._next.blendDstAlpha=n}setBlendEq(e){this._next.blendSep=false;this._next.blendEq=e}setBlendEqSep(e,t){this._next.blendSep=true;this._next.blendEq=e;this._next.blendAlphaEq=t}setCullMode(e){this._next.cullMode=e}setVertexBuffer(e,t,i=0){this._next.vertexBuffers[e]=t;this._next.vertexBufferOffsets[e]=i;if(this._next.maxStream<e){this._next.maxStream=e}}setIndexBuffer(e){this._next.indexBuffer=e}setProgram(e){this._next.program=e}setTexture(e,t,i){if(i>=this._caps.maxTextureUnits){console.warn(`Can not set texture ${e} at stage ${i}, max texture exceed: ${this._caps.maxTextureUnits}`);return}this._next.textureUnits[i]=t;this.setUniform(e,i)}setUniform(e,t,i=1){let n=this._uniforms[e];if(!n){n={dirty:true,value:t,num:i}}else{n.dirty=true;n.value=t;n.num=i}this._uniforms[e]=n}setPrimitiveType(e){this._next.primitiveType=e}draw(e,t){const i=this._gl;let n=this._current;let s=this._next;he(i,n,s);ue(i,n,s);Ee(i,n,s);pe(i,n,s);de(i,n,s);if(n.indexBuffer!==s.indexBuffer){i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,s.indexBuffer?s.indexBuffer._glID:null)}let r=false;if(n.program!==s.program){i.useProgram(s.program._glID);r=true}Fe(i,n,s);for(let e=0;e<s.program._uniforms.length;++e){let t=s.program._uniforms[e];let n=this._uniforms[t.name];if(!n){continue}if(!r&&!n.dirty){continue}n.dirty=false;let l=Te[t.type];if(!l){console.warn(`Can not find commit function for uniform ${t.name}`);continue}l(i,t.location,n.value)}if(s.indexBuffer){i.drawElements(this._next.primitiveType,t,s.indexBuffer._format,e*s.indexBuffer._bytes)}else{i.drawArrays(this._next.primitiveType,e,t)}this._stats.drawcalls+=1;n.set(s);s.reset()}}let Ae={VertexFormat:C,IndexBuffer:k,VertexBuffer:v,Program:X,Texture:G,Texture2D:Y,TextureCube:z,RenderBuffer:V,FrameBuffer:H,Device:me,attrTypeBytes:g,glFilter:D,glTextureFmt:I};Object.assign(Ae,L);return Ae}();
//# sourceMappingURL=gfx.min.js.map