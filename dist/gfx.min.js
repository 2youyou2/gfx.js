var gfx=function(){"use strict";const e=9728;const t=9729;const i=9984;const n=9985;const r=9986;const _=9987;const s=5121;const a=5123;const l=5126;const f=33635;const T=32819;const o=32820;const h=36193;const u=6402;const E=6406;const d=6407;const c=6408;const p=6409;const m=6410;const R=33776;const A=33777;const x=33778;const U=33779;const F=35840;const b=35841;const P=35842;const S=35843;const L=36196;const N=[[e,i,r],[t,n,_]];const B=[{format:d,internalFormat:R,pixelType:null},{format:c,internalFormat:A,pixelType:null},{format:c,internalFormat:x,pixelType:null},{format:c,internalFormat:U,pixelType:null},{format:d,internalFormat:L,pixelType:null},{format:d,internalFormat:b,pixelType:null},{format:c,internalFormat:S,pixelType:null},{format:d,internalFormat:F,pixelType:null},{format:c,internalFormat:P,pixelType:null},{format:E,internalFormat:E,pixelType:s},{format:p,internalFormat:p,pixelType:s},{format:m,internalFormat:m,pixelType:s},{format:d,internalFormat:d,pixelType:f},{format:c,internalFormat:c,pixelType:o},{format:c,internalFormat:c,pixelType:T},{format:d,internalFormat:d,pixelType:s},{format:c,internalFormat:c,pixelType:s},{format:d,internalFormat:d,pixelType:h},{format:c,internalFormat:c,pixelType:h},{format:d,internalFormat:d,pixelType:l},{format:c,internalFormat:c,pixelType:l},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:u,internalFormat:u,pixelType:a},{format:null,internalFormat:null,pixelType:null}];let g={USAGE_STATIC:35044,USAGE_DYNAMIC:35048,USAGE_STREAM:35040,INDEX_FMT_UINT8:5121,INDEX_FMT_UINT16:5123,INDEX_FMT_UINT32:5125,ATTR_POSITION:"a_position",ATTR_NORMAL:"a_normal",ATTR_TANGENT:"a_tangent",ATTR_BITANGENT:"a_bitangent",ATTR_WEIGHT:"a_weight",ATTR_INDICES:"a_indices",ATTR_COLOR:"a_color",ATTR_COLOR0:"a_color0",ATTR_COLOR1:"a_color1",ATTR_UV:"a_uv",ATTR_UV0:"a_uv0",ATTR_UV1:"a_uv1",ATTR_UV2:"a_uv2",ATTR_UV3:"a_uv3",ATTR_UV4:"a_uv4",ATTR_UV5:"a_uv5",ATTR_UV6:"a_uv6",ATTR_UV7:"a_uv7",ATTR_TYPE_INT8:5120,ATTR_TYPE_UINT8:5121,ATTR_TYPE_INT16:5122,ATTR_TYPE_UINT16:5123,ATTR_TYPE_INT32:5124,ATTR_TYPE_UINT32:5125,ATTR_TYPE_FLOAT32:5126,FILTER_NEAREST:0,FILTER_LINEAR:1,WRAP_REPEAT:10497,WRAP_CLAMP:33071,WRAP_MIRROR:33648,TEXTURE_FMT_RGB_DXT1:0,TEXTURE_FMT_RGBA_DXT1:1,TEXTURE_FMT_RGBA_DXT3:2,TEXTURE_FMT_RGBA_DXT5:3,TEXTURE_FMT_RGB_ETC1:4,TEXTURE_FMT_RGB_PVRTC_2BPPV1:5,TEXTURE_FMT_RGBA_PVRTC_2BPPV1:6,TEXTURE_FMT_RGB_PVRTC_4BPPV1:7,TEXTURE_FMT_RGBA_PVRTC_4BPPV1:8,TEXTURE_FMT_A8:9,TEXTURE_FMT_L8:10,TEXTURE_FMT_L8_A8:11,TEXTURE_FMT_R5_G6_B5:12,TEXTURE_FMT_R5_G5_B5_A1:13,TEXTURE_FMT_R4_G4_B4_A4:14,TEXTURE_FMT_RGB8:15,TEXTURE_FMT_RGBA8:16,TEXTURE_FMT_RGB16F:17,TEXTURE_FMT_RGBA16F:18,TEXTURE_FMT_RGB32F:19,TEXTURE_FMT_RGBA32F:20,TEXTURE_FMT_R32F:21,TEXTURE_FMT_111110F:22,TEXTURE_FMT_SRGB:23,TEXTURE_FMT_SRGBA:24,TEXTURE_FMT_DEPTH:25,TEXTURE_FMT_DEPTHSTENCIL:26,DEPTH_FUNC_NEVER:512,DEPTH_FUNC_LESS:513,DEPTH_FUNC_EQUAL:514,DEPTH_FUNC_LEQUAL:515,DEPTH_FUNC_GREATER:516,DEPTH_FUNC_NOTEQUAL:517,DEPTH_FUNC_GEQUAL:518,DEPTH_FUNC_ALWAYS:519,BLEND_FUNC_ADD:32774,BLEND_FUNC_SUBTRACT:32778,BLEND_FUNC_REVERSE_SUBTRACT:32779,BLEND_ZERO:0,BLEND_ONE:1,BLEND_SRC_COLOR:768,BLEND_ONE_MINUS_SRC_COLOR:769,BLEND_DST_COLOR:774,BLEND_ONE_MINUS_DST_COLOR:775,BLEND_SRC_ALPHA:770,BLEND_ONE_MINUS_SRC_ALPHA:771,BLEND_DST_ALPHA:772,BLEND_ONE_MINUS_DST_ALPHA:773,BLEND_CONSTANT_COLOR:32769,BLEND_ONE_MINUS_CONSTANT_COLOR:32770,BLEND_CONSTANT_ALPHA:32771,BLEND_ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_SRC_ALPHA_SATURATE:776,CULL_NONE:0,CULL_FRONT:1028,CULL_BACK:1029,CULL_FRONT_AND_BACK:1032,PT_POINTS:0,PT_LINES:1,PT_LINE_LOOP:2,PT_LINE_STRIP:3,PT_TRIANGLES:4,PT_TRIANGLE_STRIP:5,PT_TRIANGLE_FAN:6};function I(e){if(e===g.ATTR_TYPE_INT8){return 1}else if(e===g.ATTR_TYPE_UINT8){return 1}else if(e===g.ATTR_TYPE_INT16){return 2}else if(e===g.ATTR_TYPE_UINT16){return 2}else if(e===g.ATTR_TYPE_INT32){return 4}else if(e===g.ATTR_TYPE_UINT32){return 4}else if(e===g.ATTR_TYPE_FLOAT32){return 4}console.warn(`Unknown ATTR_TYPE: ${e}`);return 0}function M(e,t,i=-1){let n=N[t][i+1];if(n===undefined){console.warn(`Unknown FILTER: ${t}`);return i===-1?e.LINEAR:e.LINEAR_MIPMAP_LINEAR}return n}function C(e){let t=B[e];if(t===undefined){console.warn(`Unknown TEXTURE_FMT: ${e}`);return B[g.TEXTURE_FMT_RGBA8]}return t}class D{constructor(e){this._attr2el={};this._elements=[];this._bytes=0;let t=0;for(let i=0,n=e.length;i<n;++i){let n=e[i];let r={name:n.name,offset:t,stride:0,stream:-1,type:n.type,num:n.num,normalize:n.normalize===undefined?false:n.normalize,bytes:n.num*I(n.type)};this._attr2el[r.name]=r;this._elements.push(r);this._bytes+=r.bytes;t+=r.bytes}for(let e=0,t=this._elements.length;e<t;++e){let t=this._elements[e];t.stride=this._bytes}}element(e){return this._attr2el[e]}}class v{constructor(e,t,i,n,r,_){this._device=e;this._format=t;this._usage=i;this._persist=_;this._numIndices=r;let s=0;if(t===g.INDEX_FMT_UINT8){s=r}else if(t===g.INDEX_FMT_UINT16){s=2*r}else if(t===g.INDEX_FMT_UINT32){s=4*r}this._bytes=s;this._id=e._gl.createBuffer();this._data=null;this.update(0,n);e._stats.ib+=s}destroy(){if(this._id===-1){console.error("The buffer already destroyed");return}let e=this.device.gl;e.deleteBuffer(this._id);this.device._stats.ib-=this.bytes;this._id=-1}update(e,t){if(this._id===-1){console.error("The buffer is destroyed");return}if(t&&t.byteLength+e>this._bytes){console.error("Failed to update data, bytes exceed.");return}let i=this._device._gl;let n=this._usage;i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._id);if(!t){i.bufferData(i.ELEMENT_ARRAY_BUFFER,this._bytes,n)}else{if(e){i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,t,n)}else{i.bufferData(i.ELEMENT_ARRAY_BUFFER,t,n)}}i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);if(this._persist){if(this._data){this._data.set(t,e)}else{this._data=t}}}get count(){return this._numIndices}}class y{constructor(e,t,i,n,r,_){this._device=e;this._format=t;this._usage=i;this._persist=_;this._numVertices=r;this._bytes=this._format._bytes*r;this._id=e._gl.createBuffer();this._data=null;this.update(0,n);e._stats.vb+=this._bytes}destroy(){if(this._id===-1){console.error("The buffer already destroyed");return}let e=this.device.gl;e.deleteBuffer(this._id);this.device._stats.vb-=this.bytes;this._id=-1}update(e,t){if(this._id===-1){console.error("The buffer is destroyed");return}if(t&&t.byteLength+e>this._bytes){console.error("Failed to update data, bytes exceed.");return}let i=this._device._gl;let n=this._usage;i.bindBuffer(i.ARRAY_BUFFER,this._id);if(!t){i.bufferData(i.ARRAY_BUFFER,this._bytes,n)}else{if(e){i.bufferSubData(i.ARRAY_BUFFER,t,n)}else{i.bufferData(i.ARRAY_BUFFER,t,n)}}i.bindBuffer(i.ARRAY_BUFFER,null);if(this._persist){if(this._data){this._data.set(t,e)}else{this._data=t}}}get count(){return this._numVertices}}class X{constructor(e,t){this._device=e;this._attributes=[];this._uniforms=[];this._samplers=[];this._linked=false;this._vertSource=t.vert;this._fragSource=t.frag;this._program=null}link(){if(this._linked){return}let e=this._device._gl;let t=O(e,e.VERTEX_SHADER,this._vertSource);let i=O(e,e.FRAGMENT_SHADER,this._fragSource);let n=e.createProgram();e.attachShader(n,t);e.attachShader(n,i);e.linkProgram(n);let r=false;if(!e.getShaderParameter(t,e.COMPILE_STATUS)){console.error(`Failed to compile vertex shader: ${e.getShaderInfoLog(t)}`);r=true}if(!e.getShaderParameter(i,e.COMPILE_STATUS)){console.error(`Failed to compile fragment shader: ${e.getShaderInfoLog(i)}`);r=true}if(!e.getProgramParameter(n,e.LINK_STATUS)){console.error(`Failed to link shader program: ${e.getProgramInfoLog(n)}`);r=true}e.deleteShader(t);e.deleteShader(i);if(r){return}this._program=n;let _=e.getProgramParameter(n,e.ACTIVE_ATTRIBUTES);for(let t=0;t<_;++t){let i=e.getActiveAttrib(n,t);let r=e.getAttribLocation(n,i.name);this._attributes.push({name:i.name,location:r,type:i.type})}let s=e.getProgramParameter(n,e.ACTIVE_UNIFORMS);for(let t=0;t<s;++t){let i=e.getActiveUniform(n,t);let r=e.getUniformLocation(n,i.name);this._uniforms.push({name:i.name,location:r,type:i.type})}this._linked=true}destroy(){let e=this._device._gl;e.deleteProgram(this._program);this._linked=false;this._program=null;this._attributes=[];this._uniforms=[];this._samplers=[]}}function O(e,t,i){let n=e.createShader(t);e.shaderSource(n,i);e.compileShader(n);return n}class G{constructor(e){this._device=e;this._width=4;this._height=4;this._hasMipmap=false;this._compressed=false;this._anisotropy=1;this._minFilter=g.FILTER_LINEAR;this._magFilter=g.FILTER_LINEAR;this._mipFilter=g.FILTER_LINEAR;this._wrapS=g.WRAP_REPEAT;this._wrapT=g.WRAP_REPEAT;this._format=g.TEXTURE_FMT_RGBA8;this._target=-1}destroy(){if(this._id===-1){console.error("The texture already destroyed");return}let e=this.device.gl;e.deleteTexture(this._id);this.device._stats.tex-=this.bytes;this._id=-1}}class w extends G{constructor(e,t){super(e);this._target=this._device._gl.TEXTURE_2D;this.update(t)}update(e){let t=this._device._gl;let i=this._hasMipmap;if(e){if(e.width!==undefined){this._width=e.width}if(e.height!==undefined){this._height=e.height}if(e.anisotropy!==undefined){this._anisotropy=e.anisotropy}if(e.minFilter!==undefined){this._minFilter=e.minFilter}if(e.magFilter!==undefined){this._magFilter=e.magFilter}if(e.mipFilter!==undefined){this._mipFilter=e.mipFilter}if(e.wrapS!==undefined){this._wrapS=e.wrapS}if(e.wrapT!==undefined){this._wrapT=e.wrapT}if(e.format!==undefined){this._format=e.format;this._compressed=this._format>=g.TEXTURE_FMT_RGB_DXT1&&this._format<=g.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(e.mipmap!==undefined){this._hasMipmap=e.mipmap;i=e.mipmap}if(e.images!==undefined){if(e.images.length>1){i=false}}}this._id=t.createTexture();t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,this._id);if(e.images!==undefined){this._setMipmap(e.images,e.flipY,e.premultiplyAlpha)}this._setTexInfo();if(i){t.hint(t.GENERATE_MIPMAP_HINT,t.NICEST);t.generateMipmap(t.TEXTURE_2D)}this._device._restoreTexture(0)}_setMipmap(e,t,i){let n=this._device._gl;let r=C(this._format);for(let _=0;_<e.length;++_){let s=e[_];if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){if(t===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,true)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}n.texImage2D(n.TEXTURE_2D,_,r.internalFormat,r.format,r.pixelType,s)}else{if(t===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}if(this._compressed){n.compressedTexImage2D(n.TEXTURE_2D,_,r.internalFormat,this._width,this._height,0,s)}else{n.texImage2D(n.TEXTURE_2D,_,r.internalFormat,this._width,this._height,0,r.format,r.pixelType,s)}}}}_setTexInfo(){let e=this._device._gl;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,M(e,this._minFilter,this._hasMipmap?this._mipFilter:-1));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,M(e,this._magFilter,-1));e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this._wrapS);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this._wrapT);let t=this._device.ext("EXT_texture_filter_anisotropic");if(t){e.texParameteri(e.TEXTURE_2D,t.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}}}class Y extends G{constructor(e,t){super(e);this._target=this._device._gl.TEXTURE_CUBE_MAP;this.update(t)}update(e){let t=this._device._gl;let i=this._hasMipmap;if(e){if(e.width!==undefined){this._width=e.width}if(e.height!==undefined){this._height=e.height}if(e.anisotropy!==undefined){this._anisotropy=e.anisotropy}if(e.minFilter!==undefined){this._minFilter=e.minFilter}if(e.magFilter!==undefined){this._magFilter=e.magFilter}if(e.mipFilter!==undefined){this._mipFilter=e.mipFilter}if(e.wrapS!==undefined){this._wrapS=e.wrapS}if(e.wrapT!==undefined){this._wrapT=e.wrapT}if(e.format!==undefined){this._format=e.format;this._compressed=this._format>=g.TEXTURE_FMT_RGB_DXT1&&this._format<=g.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(e.mipmap!==undefined){this._hasMipmap=e.mipmap;i=e.mipmap}if(e.images!==undefined){if(e.images.length>1){i=false}}}this._id=t.createTexture();t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_CUBE_MAP,this._id);if(e.images!==undefined){this._setMipmap(e.images,e.flipY,e.premultiplyAlpha)}this._setTexInfo();if(i){t.hint(t.GENERATE_MIPMAP_HINT,t.NICEST);t.generateMipmap(t.TEXTURE_CUBE_MAP)}this._device._restoreTexture(0)}_setMipmap(e,t,i){let n=this._device._gl;let r=C(this._format);for(let _=0;_<e.length;++_){let s=e[_];for(let e=0;e<6;++e){if(s[e]instanceof HTMLCanvasElement||s[e]instanceof HTMLImageElement||s[e]instanceof HTMLVideoElement){if(t===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,true)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,_,r.internalFormat,r.format,r.pixelType,s[e])}else{if(t===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}if(this._compressed){n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,_,r.internalFormat,this._width,this._height,0,s[e])}else{n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,_,r.internalFormat,this._width,this._height,0,r.format,r.pixelType,s[e])}}}}}_setTexInfo(){let e=this._device._gl;e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,M(e,this._minFilter,this._hasMipmap?this._mipFilter:-1));e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,M(e,this._magFilter,-1));e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,this._wrapS);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,this._wrapT);let t=this._device.ext("EXT_texture_filter_anisotropic");if(t){e.texParameteri(e.TEXTURE_CUBE_MAP,t.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}}}const H=-1;const W={blend:false,blendSep:H,blendColor:H,blendEq:H,blendAlphaEq:H,blendSrc:H,blendDst:H,blendSrcAlpha:H,blendDstAlpha:H,depthTest:false,depthWrite:false,depthFunc:H,cullMode:H,maxStream:-1,vertexBuffers:[],vertexBufferOffsets:[],indexBuffer:null,textureUnits:[],program:null};class V{constructor(){this.vertexBuffers=[];this.vertexBufferOffsets=[];this.textureUnits=[];this.set(W)}set(e){this.blend=e.blend;if(e.blendSep!==H){this.blendSep=e.blendSep}if(e.blendColor!==H){this.blendColor=e.blendColor}if(e.blendEq!==H){this.blendEq=e.blendEq}if(e.blendAlphaEq!==H){this.blendAlphaEq=e.blendAlphaEq}if(e.blendSrc!==H){this.blendSrc=e.blendSrc}if(e.blendDst!==H){this.blendDst=e.blendDst}if(e.blendSrcAlpha!==H){this.blendSrcAlpha=e.blendSrcAlpha}if(e.blendDstAlpha!==H){this.blendDstAlpha=e.blendDstAlpha}this.depthTest=e.depthTest;this.depthWrite=e.depthWrite;if(e.depthFunc!==H){this.depthFunc=e.depthFunc}if(e.cullMode!==H){this.cullMode=e.cullMode}this.maxStream=e.maxStream;for(let t=0;t<e.vertexBuffers.length;++t){this.vertexBuffers[t]=e.vertexBuffers[t]}for(let t=0;t<e.vertexBufferOffsets.length;++t){this.vertexBufferOffsets[t]=e.vertexBufferOffsets[t]}this.indexBuffer=e.indexBuffer;for(let t=0;t<e.textureUnits.length;++t){this.textureUnits[t]=e.textureUnits[t]}this.program=e.program}reset(){this.set(W)}}const q=5124;const K=5126;const k=35664;const z=35665;const Q=35666;const j=35667;const Z=35668;const J=35669;const $=35670;const ee=35671;const te=35672;const ie=35673;const ne=35674;const re=35675;const _e=35676;const se=35678;let ae={[q]:function(e,t,i){e.uniform1i(t,i)},[K]:function(e,t,i){e.uniform1f(t,i)},[k]:function(e,t,i){e.uniform2fv(t,i)},[z]:function(e,t,i){e.uniform3fv(t,i)},[Q]:function(e,t,i){e.uniform4fv(t,i)},[j]:function(e,t,i){e.uniform2iv(t,i)},[Z]:function(e,t,i){e.uniform3iv(t,i)},[J]:function(e,t,i){e.uniform4iv(t,i)},[$]:function(e,t,i){e.uniform1i(t,i)},[ee]:function(e,t,i){e.uniform2iv(t,i)},[te]:function(e,t,i){e.uniform3iv(t,i)},[ie]:function(e,t,i){e.uniform4iv(t,i)},[ne]:function(e,t,i){e.uniformMatrix2fv(t,false,i)},[re]:function(e,t,i){e.uniformMatrix3fv(t,false,i)},[_e]:function(e,t,i){e.uniformMatrix4fv(t,false,i)},[se]:function(e,t,i){e.uniform1i(t,i)}};function le(e,t,i){if(t.blend!==i.blend){if(i.blend===false){e.disable(e.BLEND);return}else{e.enable(e.BLEND)}}else{if(i.blend===false){return}}if(t.blendColor!==i.blendColor){e.blendColor((i.blendColor>>24)/255,(i.blendColor>>16&255)/255,(i.blendColor>>8&255)/255,(i.blendColor&255)/255)}if(t.blendSep!==i.blendSep){if(i.blendSep){e.blendFuncSeparate(i.blendSrc,i.blendDst,i.blendSrcAlpha,i.blendDstAlpha);e.blendEquationSeparate(i.blendEq,i.blendAlphaEq)}else{e.blendFunc(i.blendSrc,i.blendDst);e.blendEquation(i.blendEq)}return}if(i.blendSep){if(t.blendSrc!==i.blendSrc||t.blendDst!==i.blendDst||t.blendSrcAlpha!==i.blendSrcAlpha||t.blendDstAlpha!==i.blendDstAlpha){e.blendFuncSeparate(i.blendSrc,i.blendDst,i.blendSrcAlpha,i.blendDstAlpha)}if(t.blendEq!==i.blendEq||t.blendAlphaEq!==i.blendAlphaEq){e.blendEquationSeparate(i.blendEq,i.blendAlphaEq)}}else{if(t.blendSrc!==i.blendSrc||t.blendDst!==i.blendDst){e.blendFunc(i.blendSrc,i.blendDst)}if(t.blendEq!==i.blendEq){e.blendEquation(i.blendEq)}}}function fe(e,t,i){if(t.depthWrite!==i.depthWrite){e.depthMask(i.depthWrite)}if(t.depthTest===i.depthTest){return}if(!i.depthTest){e.disable(e.DEPTH_TEST);return}e.enable(e.DEPTH_TEST);if(t.depthFunc!==i.depthFunc){e.depthFunc(i.depthFunc)}}function Te(e,t,i){if(t.cullMode===i.cullMode){return}if(i.cullMode===g.CULL_NONE){e.disable(e.CULL_FACE);return}e.enable(e.CULL_FACE);e.cullFace(i.cullMode)}function oe(e,t,i){let n=false;if(t.maxStream!==i.maxStream){n=true}else if(t.program!==i.program){n=true}else{for(let e=0;e<i.maxStream+1;++e){if(t.vertexBuffers[e]!==i.vertexBuffers[e]||t.vertexBufferOffsets[e]!==i.vertexBufferOffsets[e]){n=true;break}}}if(n){for(let t=0;t<i.maxStream+1;++t){let n=i.vertexBuffers[t];let r=i.vertexBufferOffsets[t];if(!n){continue}e.bindBuffer(e.ARRAY_BUFFER,n._id);for(let t=0;t<i.program._attributes.length;++t){let _=i.program._attributes[t];let s=n._format.element(_.name);e.enableVertexAttribArray(_.location);e.vertexAttribPointer(_.location,s.num,s.type,s.normalize,s.stride,s.offset+r*s.stride)}}}}function he(e,t,i){for(let n=0;n<i.textureUnits.length;++n){if(t.textureUnits[n]!==i.textureUnits[n]){let t=i.textureUnits[n];e.bindTexture(t._target,t._id)}}}class ue{constructor(e,t){let i;try{i=e.getContext("webgl",t)}catch(e){console.error(e);return}this._gl=i;this._extensions={};this._caps={};this._stats={texture:0,vb:0,ib:0,drawcalls:0};this._current=new V;this._next=new V;this._uniforms={};this._primitiveType=g.PT_TRIANGLES;this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0;this._initExtensions(["OES_vertex_array_object","OES_texture_float","OES_texture_half_float","OES_texture_half_float_linear","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_atc","EXT_texture_filter_anisotropic"]);this._initCaps();this._initStates()}_initExtensions(e){let t=this._gl;for(let i=0;i<e.length;++i){let n=e[i];try{let e=t.getExtension(n);if(e){this._extensions[n]=e}}catch(e){console.error(e)}}}_initCaps(){let e=this._gl;this._caps.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxFragUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)}_initStates(){let e=this._gl;e.disable(e.BLEND);e.blendFunc(e.ONE,e.ZERO);e.blendEquation(e.FUNC_ADD);e.colorMask(true,true,true,true);e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.disable(e.DEPTH_TEST);e.depthFunc(e.LESS);e.depthMask(false);e.clearDepth(1);e.clearColor(0,0,0,0);e.clearStencil(0);e.disable(e.SCISSOR_TEST)}_restoreTexture(e){let t=this._gl;let i=this._current.textureUnits[e];if(i){t.bindTexture(i._target,i._id)}else{t.bindTexture(t.TEXTURE_2D,null)}}ext(e){return this._extensions[e]}setViewport(e,t,i,n){if(this._vx!==e||this._vy!==t||this._vw!==i||this._vh!==n){this._gl.viewport(e,t,i,n);this._vx=e;this._vy=t;this._vw=i;this._vh=n}}setScissor(e,t,i,n){if(this._sx!==e||this._sy!==t||this._sw!==i||this._sh!==n){this._gl.scissor(e,t,i,n);this._sx=e;this._sy=t;this._sw=i;this._sh=n}}clear(e){let t=this._gl;let i=0;if(e.color!==undefined){i|=t.COLOR_BUFFER_BIT;t.clearColor(e.color[0],e.color[1],e.color[2],e.color[3])}if(e.depth!==undefined){i|=t.DEPTH_BUFFER_BIT;if(!this._current.depthWrite){t.depthMask(true)}t.clearDepth(e.depth)}if(e.stencil!==undefined){i|=t.STENCIL_BUFFER_BIT;t.clearStencil(e.stencil)}t.clear(i);if(e.depth!==undefined&&!this._current.depthWrite){t.depthMask(false)}}enableBlend(){this._next.blend=true}enableDepthTest(){this._next.depthTest=true}enableDepthWrite(){this._next.depthWrite=true}setBlendColor(e,t,i,n){this._next.blendColor=e*255<<24|t*255<<16|i*255<<8|n*255}setBlendFunction(e,t){this._next.blendSep=0;this._next.blendSrc=e;this._next.blendDst=t}setBlendFunctionSeparate(e,t,i,n){this._next.blendSep=1;this._next.blendSrc=e;this._next.blendDst=t;this._next.blendSrcAlpha=i;this._next.blendDstAlpha=n}setBlendEquation(e){this._next.blendSep=0;this._next.blendEq=e}setBlendEquationSeparate(e,t){this._next.blendSep=1;this._next.blendEq=e;this._next.blendAlphaEq=t}setCullMode(e){this._next.cullMode=e}setVertexBuffer(e,t,i=0){this._next.vertexBuffers[e]=t;this._next.vertexBufferOffsets[e]=i;if(this._next.maxStream<e){this._next.maxStream=e}}setIndexBuffer(e){this._next.indexBuffer=e}setProgram(e){this._next.program=e}setTexture(e,t,i){if(i>=this._caps.maxTextureUnits){console.warn(`Can not set texture ${e} at stage ${i}, max texture exceed: ${this._caps.maxTextureUnits}`);return}this._next.textureUnits[i]=t;this.setUniform(e,i)}setUniform(e,t,i=1){let n=this._uniforms[e];if(!n){n={dirty:true,value:t,num:i}}else{n.dirty=true;n.value=t;n.num=i}this._uniforms[e]=n}setPrimitiveType(e){this._primitiveType=e}draw(e,t){let i=this._current;let n=this._next;let r=this._gl;le(r,i,n);fe(r,i,n);Te(r,i,n);oe(r,i,n);if(i.indexBuffer!==n.indexBuffer){r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n.indexBuffer?n.indexBuffer._id:null)}if(i.program!==n.program){r.useProgram(n.program._program)}he(r,i,n);for(let e=0;e<n.program._uniforms.length;++e){let t=n.program._uniforms[e];let i=this._uniforms[t.name];if(!i){continue}if(!i.dirty){continue}i.dirty=false;let _=ae[t.type];if(!_){console.warn(`Can not find commit function for uniform ${t.name}`);continue}_(r,t.location,i.value)}if(n.indexBuffer){r.drawElements(this._primitiveType,t,n.indexBuffer._format,e*n.indexBuffer._bytes)}else{r.drawArrays(this._primitiveType,e,t)}this._stats.drawcalls+=1;i.set(n);n.reset()}}let Ee={VertexFormat:D,IndexBuffer:v,VertexBuffer:y,Program:X,Texture:G,Texture2D:w,TextureCube:Y,Device:ue,attrTypeBytes:I,glFilter:M,glTextureFmt:C};Object.assign(Ee,g);return Ee}();
//# sourceMappingURL=gfx.min.js.map